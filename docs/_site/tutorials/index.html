<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/ModCube.github.io/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/ModCube.github.io/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(3)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; } </style> <script src="/ModCube.github.io/assets/js/vendor/lunr.min.js"></script> <script src="/ModCube.github.io/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Tutorials | RS-ModCubes</title> <meta name="generator" content="Jekyll v4.3.4" /> <meta property="og:title" content="Tutorials" /> <meta name="author" content="Jiaxi Zheng" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations" /> <meta property="og:description" content="Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations" /> <link rel="canonical" href="http://0.0.0.0:4000/ModCube.github.io/tutorials/" /> <meta property="og:url" content="http://0.0.0.0:4000/ModCube.github.io/tutorials/" /> <meta property="og:site_name" content="RS-ModCubes" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Tutorials" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Jiaxi Zheng"},"description":"Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations","headline":"Tutorials","url":"http://0.0.0.0:4000/ModCube.github.io/tutorials/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/ModCube.github.io/" class="site-title lh-tight"> RS-ModCubes </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/ModCube.github.io/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/ModCube.github.io/architecture/" class="nav-list-link">System Architecture</a></li><li class="nav-list-item"><a href="/ModCube.github.io/tutorials/" class="nav-list-link">Tutorials</a></li><li class="nav-list-item"><a href="/ModCube.github.io/api/" class="nav-list-link">API Documentation</a></li><li class="nav-list-item"><a href="/ModCube.github.io/examples/" class="nav-list-link">Examples</a></li><li class="nav-list-item"><a href="/ModCube.github.io/installation/" class="nav-list-link">Installation Guide</a></li><li class="nav-list-item"><a href="/ModCube.github.io/faq/" class="nav-list-link">FAQ</a></li><li class="nav-list-item"><a href="/ModCube.github.io/contributing/" class="nav-list-link">Contributing</a></li><li class="nav-list-item"><a href="/ModCube.github.io/changelog/" class="nav-list-link">Changelog</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/jiaxi-zheng/ModCube.github.io" class="nav-list-link external" > GitHub Repository <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RS-ModCubes" aria-label="Search RS-ModCubes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="tutorials"> <a href="#tutorials" class="anchor-heading" aria-labelledby="tutorials"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tutorials </h1> <p>This section provides comprehensive tutorials for using the RS-ModCubes system, from basic operations to advanced configurations.</p> <h2 id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h2> <ol> <li><a href="#quick-start">Quick Start</a></li> <li><a href="#basic-simulation">Basic Simulation</a></li> <li><a href="#control-system-tutorial">Control System Tutorial</a></li> <li><a href="#mission-planning">Mission Planning</a></li> <li><a href="#hardware-integration">Hardware Integration</a></li> <li><a href="#advanced-configuration">Advanced Configuration</a></li> <li><a href="#troubleshooting">Troubleshooting</a></li> </ol> <h2 id="quick-start"> <a href="#quick-start" class="anchor-heading" aria-labelledby="quick-start"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Quick Start </h2> <h3 id="launch-your-first-simulation"> <a href="#launch-your-first-simulation" class="anchor-heading" aria-labelledby="launch-your-first-simulation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Launch Your First Simulation </h3> <p>After completing the installation, letâ€™s start with a basic simulation:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Terminal 1: Launch the system</span>
roslaunch modcube_mission system.launch model_name:<span class="o">=</span>modcube simulated:<span class="o">=</span><span class="nb">true</span>

<span class="c"># Terminal 2: Check system status</span>
rostopic <span class="nb">echo</span> /modcube/nav_state

<span class="c"># Terminal 3: Send a simple command</span>
rostopic pub /modcube/controller_command modcube_msgs/ControllerCommand <span class="se">\</span>
  <span class="s2">"header:
    stamp: now
    frame_id: 'base_link'
  mode: 1
  setpoint:
    position:
      x: 1.0
      y: 0.0
      z: -1.0
    orientation:
      x: 0.0
      y: 0.0
      z: 0.0
      w: 1.0"</span>
</code></pre></div></div> <p>This will:</p> <ol> <li>Launch the complete ModCube system in simulation mode</li> <li>Display the current navigation state</li> <li>Command the robot to move to position (1, 0, -1)</li> </ol> <h3 id="understanding-the-system-status"> <a href="#understanding-the-system-status" class="anchor-heading" aria-labelledby="understanding-the-system-status"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding the System Status </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check running nodes</span>
rosnode list

<span class="c"># Check available topics</span>
rostopic list

<span class="c"># Check available services</span>
rosservice list

<span class="c"># Monitor system health</span>
rostopic <span class="nb">echo</span> /modcube/alarms
</code></pre></div></div> <h2 id="basic-simulation"> <a href="#basic-simulation" class="anchor-heading" aria-labelledby="basic-simulation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Simulation </h2> <h3 id="available-simulation-worlds"> <a href="#available-simulation-worlds" class="anchor-heading" aria-labelledby="available-simulation-worlds"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Available Simulation Worlds </h3> <p>The ModCube system includes several pre-configured simulation environments:</p> <h4 id="1-base-pool-environment"> <a href="#1-base-pool-environment" class="anchor-heading" aria-labelledby="1-base-pool-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Base Pool Environment </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch base pool simulation</span>
roslaunch modcube_sim_worlds base_pool.launch

<span class="c"># In another terminal, launch the vehicle</span>
roslaunch modcube_mission system.launch model_name:<span class="o">=</span>modcube simulated:<span class="o">=</span><span class="nb">true </span>world:<span class="o">=</span>base_pool
</code></pre></div></div> <h4 id="2-transdec-environment"> <a href="#2-transdec-environment" class="anchor-heading" aria-labelledby="2-transdec-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Transdec Environment </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch Transdec simulation (more complex environment)</span>
roslaunch modcube_sim_worlds transdec.launch

<span class="c"># Launch vehicle in Transdec world</span>
roslaunch modcube_mission system.launch model_name:<span class="o">=</span>modcube simulated:<span class="o">=</span><span class="nb">true </span>world:<span class="o">=</span>transdec
</code></pre></div></div> <h4 id="3-umd-test-environment"> <a href="#3-umd-test-environment" class="anchor-heading" aria-labelledby="3-umd-test-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. UMD Test Environment </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch UMD simulation</span>
roslaunch modcube_sim_worlds umd.launch

<span class="c"># Launch vehicle in UMD world</span>
roslaunch modcube_mission system.launch model_name:<span class="o">=</span>modcube simulated:<span class="o">=</span><span class="nb">true </span>world:<span class="o">=</span>umd
</code></pre></div></div> <h3 id="simulation-controls"> <a href="#simulation-controls" class="anchor-heading" aria-labelledby="simulation-controls"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Simulation Controls </h3> <h4 id="using-keyboard-teleop"> <a href="#using-keyboard-teleop" class="anchor-heading" aria-labelledby="using-keyboard-teleop"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Keyboard Teleop </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch teleoperation</span>
roslaunch modcube_common teleop.launch

<span class="c"># Control keys:</span>
<span class="c"># W/S: Forward/Backward</span>
<span class="c"># A/D: Left/Right</span>
<span class="c"># Q/E: Up/Down</span>
<span class="c"># I/K: Pitch up/down</span>
<span class="c"># J/L: Yaw left/right</span>
<span class="c"># U/O: Roll left/right</span>
</code></pre></div></div> <h4 id="using-rqt-control-panel"> <a href="#using-rqt-control-panel" class="anchor-heading" aria-labelledby="using-rqt-control-panel"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using RQT Control Panel </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch RQT with custom perspective</span>
rqt <span class="nt">--perspective-file</span> <span class="si">$(</span>rospack find modcube_common<span class="si">)</span>/config/modcube.perspective
</code></pre></div></div> <h2 id="control-system-tutorial"> <a href="#control-system-tutorial" class="anchor-heading" aria-labelledby="control-system-tutorial"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Control System Tutorial </h2> <h3 id="understanding-the-control-architecture"> <a href="#understanding-the-control-architecture" class="anchor-heading" aria-labelledby="understanding-the-control-architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding the Control Architecture </h3> <p>The ModCube control system uses a hierarchical approach:</p> <ol> <li><strong>Mission Level</strong>: High-level goals and tasks</li> <li><strong>Guidance Level</strong>: Path planning and trajectory generation</li> <li><strong>Control Level</strong>: PID controllers and thrust allocation</li> <li><strong>Actuation Level</strong>: Individual thruster control</li> </ol> <h3 id="pid-controller-configuration"> <a href="#pid-controller-configuration" class="anchor-heading" aria-labelledby="pid-controller-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PID Controller Configuration </h3> <h4 id="viewing-current-pid-parameters"> <a href="#viewing-current-pid-parameters" class="anchor-heading" aria-labelledby="viewing-current-pid-parameters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Viewing Current PID Parameters </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get current PID parameters</span>
rosservice call /modcube/get_pid_params
</code></pre></div></div> <h4 id="tuning-pid-parameters"> <a href="#tuning-pid-parameters" class="anchor-heading" aria-labelledby="tuning-pid-parameters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tuning PID Parameters </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set position PID gains</span>
rosservice call /modcube/set_pid_params <span class="se">\</span>
  <span class="s2">"position_gains:
    p: [10.0, 10.0, 10.0]
    i: [0.1, 0.1, 0.1]
    d: [5.0, 5.0, 5.0]
  orientation_gains:
    p: [20.0, 20.0, 20.0]
    i: [0.2, 0.2, 0.2]
    d: [8.0, 8.0, 8.0]"</span>
</code></pre></div></div> <h4 id="real-time-pid-tuning-with-rqt"> <a href="#real-time-pid-tuning-with-rqt" class="anchor-heading" aria-labelledby="real-time-pid-tuning-with-rqt"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Real-time PID Tuning with RQT </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch dynamic reconfigure GUI</span>
rosrun rqt_reconfigure rqt_reconfigure

<span class="c"># Select /modcube/pid_controller for real-time tuning</span>
</code></pre></div></div> <h3 id="thruster-management"> <a href="#thruster-management" class="anchor-heading" aria-labelledby="thruster-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Thruster Management </h3> <h4 id="thruster-configuration"> <a href="#thruster-configuration" class="anchor-heading" aria-labelledby="thruster-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Thruster Configuration </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># View current thruster configuration</span>
rosservice call /modcube/get_thruster_config

<span class="c"># Test individual thrusters</span>
rostopic pub /modcube/thruster_test modcube_msgs/ThrusterCommand <span class="se">\</span>
  <span class="s2">"header:
    stamp: now
  thrusters: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]"</span>
</code></pre></div></div> <h4 id="thrust-allocation-matrix-tam"> <a href="#thrust-allocation-matrix-tam" class="anchor-heading" aria-labelledby="thrust-allocation-matrix-tam"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Thrust Allocation Matrix (TAM) </h4> <p>The system uses a 14-thruster configuration. Understanding the TAM:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example TAM structure (simplified)
# Each row represents [Fx, Fy, Fz, Tx, Ty, Tz] for each thruster
</span><span class="n">TAM</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Thruster 0: Forward thrust
</span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Thruster 1: Lateral thrust
</span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Thruster 2: Vertical thrust
</span>    <span class="c1"># ... additional thrusters
</span><span class="p">]</span>
</code></pre></div></div> <h3 id="control-modes"> <a href="#control-modes" class="anchor-heading" aria-labelledby="control-modes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Control Modes </h3> <p>The system supports multiple control modes:</p> <h4 id="1-position-control"> <a href="#1-position-control" class="anchor-heading" aria-labelledby="1-position-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Position Control </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rostopic pub /modcube/controller_command modcube_msgs/ControllerCommand <span class="se">\</span>
  <span class="s2">"header:
    stamp: now
  mode: 1  # Position control mode
  setpoint:
    position: {x: 2.0, y: 1.0, z: -2.0}
    orientation: {x: 0, y: 0, z: 0, w: 1}"</span>
</code></pre></div></div> <h4 id="2-velocity-control"> <a href="#2-velocity-control" class="anchor-heading" aria-labelledby="2-velocity-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Velocity Control </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rostopic pub /modcube/controller_command modcube_msgs/ControllerCommand <span class="se">\</span>
  <span class="s2">"header:
    stamp: now
  mode: 2  # Velocity control mode
  setpoint:
    linear: {x: 0.5, y: 0.0, z: 0.0}
    angular: {x: 0, y: 0, z: 0.1}"</span>
</code></pre></div></div> <h4 id="3-direct-thrust-control"> <a href="#3-direct-thrust-control" class="anchor-heading" aria-labelledby="3-direct-thrust-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Direct Thrust Control </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rostopic pub /modcube/thrust_command modcube_msgs/ThrusterCommand <span class="se">\</span>
  <span class="s2">"header:
    stamp: now
  thrusters: [0.1, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]"</span>
</code></pre></div></div> <h2 id="mission-planning"> <a href="#mission-planning" class="anchor-heading" aria-labelledby="mission-planning"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mission Planning </h2> <h3 id="creating-simple-missions"> <a href="#creating-simple-missions" class="anchor-heading" aria-labelledby="creating-simple-missions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating Simple Missions </h3> <h4 id="waypoint-navigation"> <a href="#waypoint-navigation" class="anchor-heading" aria-labelledby="waypoint-navigation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Waypoint Navigation </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Quaternion</span>

<span class="k">def</span> <span class="nf">navigate_waypoints</span><span class="p">():</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">waypoint_navigator</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="c1"># Start position
</span>        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="c1"># Move forward
</span>        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="c1"># Move right
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="c1"># Move back
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="c1"># Return to start
</span>    <span class="p">]</span>
    
    <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Rate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1 Hz
</span>    
    <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ControllerCommand</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Position control
</span>        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">wp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="nc">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Moving to waypoint: </span><span class="si">{</span><span class="n">wp</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Wait for 10 seconds at each waypoint
</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">rate</span><span class="p">.</span><span class="nf">sleep</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">navigate_waypoints</span><span class="p">()</span>
</code></pre></div></div> <h4 id="using-the-mission-manager"> <a href="#using-the-mission-manager" class="anchor-heading" aria-labelledby="using-the-mission-manager"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using the Mission Manager </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch mission manager</span>
roslaunch modcube_mission mission_manager.launch

<span class="c"># Send mission command</span>
rosservice call /modcube/mission_control <span class="se">\</span>
  <span class="s2">"command: 'start'
   mission_type: 'waypoint_navigation'
   parameters: ['waypoint_file:=/path/to/waypoints.yaml']"</span>
</code></pre></div></div> <h3 id="advanced-mission-examples"> <a href="#advanced-mission-examples" class="anchor-heading" aria-labelledby="advanced-mission-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Mission Examples </h3> <h4 id="search-pattern-mission"> <a href="#search-pattern-mission" class="anchor-heading" aria-labelledby="search-pattern-mission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Search Pattern Mission </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># search_pattern.yaml</span>
<span class="na">mission</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">search_pattern"</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">search_area</span><span class="pi">:</span>
      <span class="na">min_x</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">max_x</span><span class="pi">:</span> <span class="m">10</span>
      <span class="na">min_y</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">max_y</span><span class="pi">:</span> <span class="m">10</span>
      <span class="na">depth</span><span class="pi">:</span> <span class="s">-2.0</span>
    <span class="na">pattern_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">lawnmower"</span>
    <span class="na">spacing</span><span class="pi">:</span> <span class="m">2.0</span>
    <span class="na">speed</span><span class="pi">:</span> <span class="m">0.5</span>
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Execute search pattern</span>
rosservice call /modcube/mission_control <span class="se">\</span>
  <span class="s2">"command: 'start'
   mission_type: 'search_pattern'
   parameters: ['config_file:=search_pattern.yaml']"</span>
</code></pre></div></div> <h2 id="hardware-integration"> <a href="#hardware-integration" class="anchor-heading" aria-labelledby="hardware-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hardware Integration </h2> <h3 id="imu-integration"> <a href="#imu-integration" class="anchor-heading" aria-labelledby="imu-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> IMU Integration </h3> <h4 id="xsens-imu-setup"> <a href="#xsens-imu-setup" class="anchor-heading" aria-labelledby="xsens-imu-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Xsens IMU Setup </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch Xsens IMU driver</span>
roslaunch modcube_vehicle xsens_imu.launch

<span class="c"># Check IMU data</span>
rostopic <span class="nb">echo</span> /modcube/imu/data

<span class="c"># Calibrate IMU (follow manufacturer instructions)</span>
rosservice call /modcube/imu/calibrate
</code></pre></div></div> <h4 id="imu-configuration"> <a href="#imu-configuration" class="anchor-heading" aria-labelledby="imu-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> IMU Configuration </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># imu_config.yaml</span>
<span class="na">imu</span><span class="pi">:</span>
  <span class="na">frame_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">imu_link"</span>
  <span class="na">frequency</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">orientation_covariance</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.01</span><span class="pi">]</span>
  <span class="na">angular_velocity_covariance</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.001</span><span class="pi">,</span> <span class="nv">0.001</span><span class="pi">,</span> <span class="nv">0.001</span><span class="pi">]</span>
  <span class="na">linear_acceleration_covariance</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.01</span><span class="pi">]</span>
</code></pre></div></div> <h3 id="dvl-integration"> <a href="#dvl-integration" class="anchor-heading" aria-labelledby="dvl-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DVL Integration </h3> <h4 id="teledyne-dvl-setup"> <a href="#teledyne-dvl-setup" class="anchor-heading" aria-labelledby="teledyne-dvl-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Teledyne DVL Setup </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch DVL driver</span>
roslaunch modcube_vehicle teledyne_dvl.launch port:<span class="o">=</span>/dev/ttyUSB0

<span class="c"># Check DVL data</span>
rostopic <span class="nb">echo</span> /modcube/dvl/data

<span class="c"># Test DVL communication</span>
rosservice call /modcube/dvl/test_communication
</code></pre></div></div> <h3 id="thruster-integration"> <a href="#thruster-integration" class="anchor-heading" aria-labelledby="thruster-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Thruster Integration </h3> <h4 id="pololu-maestro-setup"> <a href="#pololu-maestro-setup" class="anchor-heading" aria-labelledby="pololu-maestro-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Pololu Maestro Setup </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Launch thruster controller</span>
roslaunch modcube_vehicle actuators.launch

<span class="c"># Test thruster response</span>
rosservice call /modcube/test_thrusters
</code></pre></div></div> <h4 id="thruster-calibration"> <a href="#thruster-calibration" class="anchor-heading" aria-labelledby="thruster-calibration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Thruster Calibration </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# thruster_calibration.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ThrusterCommand</span>

<span class="k">def</span> <span class="nf">calibrate_thrusters</span><span class="p">():</span>
    <span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/thrust_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">ThrusterCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># Test each thruster individually
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ThrusterCommand</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">thrusters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">14</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">thrusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 10% thrust
</span>        
        <span class="n">pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Testing thruster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Stop thruster
</span>        <span class="n">cmd</span><span class="p">.</span><span class="n">thrusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div> <h2 id="advanced-configuration"> <a href="#advanced-configuration" class="anchor-heading" aria-labelledby="advanced-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Configuration </h2> <h3 id="custom-vehicle-configuration"> <a href="#custom-vehicle-configuration" class="anchor-heading" aria-labelledby="custom-vehicle-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom Vehicle Configuration </h3> <h4 id="creating-a-new-vehicle-model"> <a href="#creating-a-new-vehicle-model" class="anchor-heading" aria-labelledby="creating-a-new-vehicle-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating a New Vehicle Model </h4> <ol> <li><strong>Create vehicle description</strong>:</li> </ol> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- my_vehicle.xacro --&gt;</span>
<span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;robot</span> <span class="na">xmlns:xacro=</span><span class="s">"http://www.ros.org/wiki/xacro"</span> <span class="na">name=</span><span class="s">"my_vehicle"</span><span class="nt">&gt;</span>
  
  <span class="c">&lt;!-- Include base ModCube components --&gt;</span>
  <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"$(find modcube_config)/modcube_description/urdf/base.xacro"</span><span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- Custom thruster configuration --&gt;</span>
  <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"$(find my_vehicle_config)/urdf/thrusters_custom.xacro"</span><span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- Custom sensor configuration --&gt;</span>
  <span class="nt">&lt;xacro:include</span> <span class="na">filename=</span><span class="s">"$(find my_vehicle_config)/urdf/sensors_custom.xacro"</span><span class="nt">/&gt;</span>
  
<span class="nt">&lt;/robot&gt;</span>
</code></pre></div></div> <ol> <li><strong>Create launch file</strong>:</li> </ol> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- my_vehicle.launch --&gt;</span>
<span class="nt">&lt;launch&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">"namespace"</span> <span class="na">default=</span><span class="s">"my_vehicle"</span><span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- Load vehicle description --&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"robot_description"</span> 
         <span class="na">command=</span><span class="s">"$(find xacro)/xacro $(find my_vehicle_config)/urdf/my_vehicle.xacro"</span><span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- Launch vehicle-specific nodes --&gt;</span>
  <span class="nt">&lt;group</span> <span class="na">ns=</span><span class="s">"$(arg namespace)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">file=</span><span class="s">"$(find modcube_vehicle)/launch/base_vehicle.launch"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">"namespace"</span> <span class="na">value=</span><span class="s">"$(arg namespace)"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    
    <span class="c">&lt;!-- Custom nodes --&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">name=</span><span class="s">"custom_sensor"</span> <span class="na">pkg=</span><span class="s">"my_vehicle_drivers"</span> <span class="na">type=</span><span class="s">"custom_sensor_node"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/group&gt;</span>
  
<span class="nt">&lt;/launch&gt;</span>
</code></pre></div></div> <h3 id="custom-control-algorithms"> <a href="#custom-control-algorithms" class="anchor-heading" aria-labelledby="custom-control-algorithms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom Control Algorithms </h3> <h4 id="implementing-a-custom-controller"> <a href="#implementing-a-custom-controller" class="anchor-heading" aria-labelledby="implementing-a-custom-controller"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementing a Custom Controller </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# custom_controller.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">ThrusterCommand</span>
<span class="kn">from</span> <span class="n">modcube_common.controllers.controller</span> <span class="kn">import</span> <span class="n">BaseController</span>

<span class="k">class</span> <span class="nc">CustomController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="c1"># Custom parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">custom_gain</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">get_param</span><span class="p">(</span><span class="sh">'</span><span class="s">~custom_gain</span><span class="sh">'</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">thrust_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/thrust_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">ThrusterCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nav_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">nav_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cmd_callback</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_command</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">nav_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">update_control</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">cmd_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_command</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">update_control</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_state</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">current_command</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Custom control algorithm
</span>        <span class="n">error</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_error</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">current_command</span><span class="p">)</span>
        <span class="n">wrench</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">compute_wrench</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">thrust_cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">allocate_thrust</span><span class="p">(</span><span class="n">wrench</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">thrust_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">thrust_cmd</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">compute_error</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="c1"># Implement custom error computation
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compute_wrench</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="c1"># Implement custom control law
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">allocate_thrust</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">wrench</span><span class="p">):</span>
        <span class="c1"># Use existing thrust allocation
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">thrust_allocator</span><span class="p">.</span><span class="nf">allocate</span><span class="p">(</span><span class="n">wrench</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">custom_controller</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="nc">CustomController</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
</code></pre></div></div> <h3 id="sensor-fusion-configuration"> <a href="#sensor-fusion-configuration" class="anchor-heading" aria-labelledby="sensor-fusion-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sensor Fusion Configuration </h3> <h4 id="custom-state-estimator"> <a href="#custom-state-estimator" class="anchor-heading" aria-labelledby="custom-state-estimator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom State Estimator </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# custom_estimator.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Imu</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">NavState</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">PoseWithCovariance</span><span class="p">,</span> <span class="n">TwistWithCovariance</span>

<span class="k">class</span> <span class="nc">CustomStateEstimator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Initialize Kalman filter or other estimator
</span>        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># [x, y, z, roll, pitch, yaw, vx, vy, vz, wx, wy, wz]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/imu/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/dvl/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_callback</span><span class="p">)</span>
        
        <span class="c1"># Timer for state prediction
</span>        <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">predict_step</span><span class="p">)</span>  <span class="c1"># 100 Hz
</span>    
    <span class="k">def</span> <span class="nf">predict_step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># Implement prediction step
</span>        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="c1"># Update state prediction
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">publish_state</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">imu_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Update with IMU measurements
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">dvl_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Update with DVL measurements
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">publish_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">nav_msg</span> <span class="o">=</span> <span class="nc">NavState</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">"</span><span class="s">odom</span><span class="sh">"</span>
        
        <span class="c1"># Fill in state information
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># ... fill in remaining fields
</span>        
        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">nav_msg</span><span class="p">)</span>
</code></pre></div></div> <h2 id="troubleshooting"> <a href="#troubleshooting" class="anchor-heading" aria-labelledby="troubleshooting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Troubleshooting </h2> <h3 id="common-issues-and-solutions"> <a href="#common-issues-and-solutions" class="anchor-heading" aria-labelledby="common-issues-and-solutions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Common Issues and Solutions </h3> <h4 id="1-simulation-performance-issues"> <a href="#1-simulation-performance-issues" class="anchor-heading" aria-labelledby="1-simulation-performance-issues"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Simulation Performance Issues </h4> <p><strong>Problem</strong>: Gazebo runs slowly or crashes</p> <p><strong>Solutions</strong>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Reduce simulation complexity</span>
<span class="nb">export </span><span class="nv">GAZEBO_MODEL_PATH</span><span class="o">=</span>/path/to/simple/models

<span class="c"># Use software rendering</span>
<span class="nb">export </span><span class="nv">LIBGL_ALWAYS_SOFTWARE</span><span class="o">=</span>1

<span class="c"># Reduce physics update rate</span>
<span class="c"># Edit world file: &lt;physics&gt;&lt;real_time_update_rate&gt;100&lt;/real_time_update_rate&gt;&lt;/physics&gt;</span>
</code></pre></div></div> <h4 id="2-control-system-issues"> <a href="#2-control-system-issues" class="anchor-heading" aria-labelledby="2-control-system-issues"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Control System Issues </h4> <p><strong>Problem</strong>: Robot doesnâ€™t respond to commands</p> <p><strong>Debugging steps</strong>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check if controller is running</span>
rosnode list | <span class="nb">grep </span>controller

<span class="c"># Check command topics</span>
rostopic <span class="nb">echo</span> /modcube/controller_command

<span class="c"># Check thrust output</span>
rostopic <span class="nb">echo</span> /modcube/thrust_command

<span class="c"># Verify thruster allocation</span>
rosservice call /modcube/get_thruster_config
</code></pre></div></div> <h4 id="3-hardware-communication-issues"> <a href="#3-hardware-communication-issues" class="anchor-heading" aria-labelledby="3-hardware-communication-issues"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Hardware Communication Issues </h4> <p><strong>Problem</strong>: Cannot communicate with hardware</p> <p><strong>Solutions</strong>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check device permissions</span>
<span class="nb">ls</span> <span class="nt">-l</span> /dev/ttyUSB<span class="k">*</span>
<span class="nb">sudo chmod </span>666 /dev/ttyUSB0

<span class="c"># Check if device is detected</span>
dmesg | <span class="nb">grep tty</span>

<span class="c"># Test serial communication</span>
<span class="nb">sudo </span>minicom <span class="nt">-D</span> /dev/ttyUSB0 <span class="nt">-b</span> 115200
</code></pre></div></div> <h3 id="debug-tools"> <a href="#debug-tools" class="anchor-heading" aria-labelledby="debug-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debug Tools </h3> <h4 id="ros-debug-commands"> <a href="#ros-debug-commands" class="anchor-heading" aria-labelledby="ros-debug-commands"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ROS Debug Commands </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Monitor all topics</span>
rostopic list | xargs <span class="nt">-I</span> <span class="o">{}</span> rostopic <span class="nb">echo</span> <span class="o">{}</span> <span class="nt">--noarr</span>

<span class="c"># Check node graph</span>
rqt_graph

<span class="c"># Monitor system resources</span>
htop

<span class="c"># Check ROS logs</span>
roscd <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ../log
<span class="nb">tail</span> <span class="nt">-f</span> latest/rosout.log
</code></pre></div></div> <h4 id="gazebo-debug"> <a href="#gazebo-debug" class="anchor-heading" aria-labelledby="gazebo-debug"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gazebo Debug </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Verbose Gazebo output</span>
gazebo <span class="nt">--verbose</span>

<span class="c"># Check Gazebo plugins</span>
gzserver <span class="nt">--verbose</span>

<span class="c"># Monitor Gazebo topics</span>
gz topic <span class="nt">-l</span>
gz topic <span class="nt">-e</span> /gazebo/default/physics/contacts
</code></pre></div></div> <h3 id="performance-monitoring"> <a href="#performance-monitoring" class="anchor-heading" aria-labelledby="performance-monitoring"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Performance Monitoring </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Monitor ROS node performance</span>
rosrun rqt_top rqt_top

<span class="c"># Check message frequencies</span>
rostopic hz /modcube/nav_state
rostopic hz /modcube/controller_command

<span class="c"># Monitor network usage</span>
iftop
</code></pre></div></div> <h2 id="advanced-topics"> <a href="#advanced-topics" class="anchor-heading" aria-labelledby="advanced-topics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Topics </h2> <h3 id="deep-learning-integration"> <a href="#deep-learning-integration" class="anchor-heading" aria-labelledby="deep-learning-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deep Learning Integration </h3> <h4 id="object-detection-with-yolo"> <a href="#object-detection-with-yolo" class="anchor-heading" aria-labelledby="object-detection-with-yolo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Object Detection with YOLO </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# yolo_detector.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="n">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">DetectedObjects</span><span class="p">,</span> <span class="n">DetectedObject</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">ultralytics</span> <span class="kn">import</span> <span class="n">YOLO</span>

<span class="k">class</span> <span class="nc">YOLODetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">yolo_detector</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Load YOLO model
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">YOLO</span><span class="p">(</span><span class="sh">'</span><span class="s">yolov8n.pt</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># or custom trained model
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">detection_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/detections</span><span class="sh">'</span><span class="p">,</span> <span class="n">DetectedObjects</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">debug_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/debug/detection_image</span><span class="sh">'</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Detection parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">get_param</span><span class="p">(</span><span class="sh">'</span><span class="s">~confidence_threshold</span><span class="sh">'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nms_threshold</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">get_param</span><span class="p">(</span><span class="sh">'</span><span class="s">~nms_threshold</span><span class="sh">'</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">bgr8</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">detections</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_objects</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">publish_detections</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Detection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">detect_objects</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="c1"># Run YOLO inference
</span>        <span class="n">results</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">confidence_threshold</span><span class="p">,</span> <span class="n">iou</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">nms_threshold</span><span class="p">)</span>
        
        <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">boxes</span>
            <span class="k">if</span> <span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                    <span class="c1"># Extract detection information
</span>                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">xyxy</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
                    <span class="n">class_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">cls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">())</span>
                    <span class="n">class_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">names</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
                    
                    <span class="n">detection</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span>
                        <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">class_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">class_id</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">class_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">class_name</span>
                    <span class="p">}</span>
                    <span class="n">detections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">detection</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">detections</span>
    
    <span class="k">def</span> <span class="nf">publish_detections</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nc">DetectedObjects</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nc">DetectedObject</span><span class="p">()</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">class_name</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">bbox</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">bbox</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">bbox</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="p">.</span><span class="n">bbox</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">det</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">msg</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">detection_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="nc">YOLODetector</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
</code></pre></div></div> <h4 id="visual-slam-integration"> <a href="#visual-slam-integration" class="anchor-heading" aria-labelledby="visual-slam-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Visual SLAM Integration </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# visual_slam.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">CameraInfo</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">PoseStamped</span>
<span class="kn">from</span> <span class="n">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span>
<span class="kn">import</span> <span class="n">g2o</span>

<span class="k">class</span> <span class="nc">VisualSLAM</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">visual_slam</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">ORB_create</span><span class="p">(</span><span class="n">nfeatures</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Camera parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">K</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Camera intrinsic matrix
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># SLAM state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># Current pose
</span>        <span class="n">self</span><span class="p">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">map_points</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">info_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/camera_info</span><span class="sh">'</span><span class="p">,</span> <span class="n">CameraInfo</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">info_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pose_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/slam/pose</span><span class="sh">'</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">info_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Extract camera intrinsic parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">K</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">K</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">mono8</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">process_frame</span><span class="p">(</span><span class="n">cv_image</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SLAM error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">process_frame</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="c1"># Extract ORB features
</span>        <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">orb</span><span class="p">.</span><span class="nf">detectAndCompute</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prev_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">prev_desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Match features
</span>            <span class="n">matches</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">matcher</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prev_desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">distance</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Minimum matches threshold
</span>                <span class="c1"># Extract matched points
</span>                <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">prev_kp</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">queryIdx</span><span class="p">].</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">([</span><span class="n">kp</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">trainIdx</span><span class="p">].</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                
                <span class="c1"># Estimate motion
</span>                <span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findEssentialMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">K</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">RANSAC</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">K</span><span class="p">)</span>
                
                <span class="c1"># Update pose
</span>                <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
                <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">flatten</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">@</span> <span class="n">T</span>
                
                <span class="c1"># Triangulate 3D points
</span>                <span class="n">self</span><span class="p">.</span><span class="nf">triangulate_points</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                
                <span class="c1"># Publish pose
</span>                <span class="n">self</span><span class="p">.</span><span class="nf">publish_pose</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        
        <span class="c1"># Update previous frame
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="n">kp</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="n">desc</span>
    
    <span class="k">def</span> <span class="nf">triangulate_points</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Triangulate 3D points from stereo correspondences
</span>        <span class="n">P1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">K</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="nf">hstack</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span>
        <span class="n">P2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">K</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="nf">hstack</span><span class="p">([</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
        
        <span class="n">points_4d</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">triangulatePoints</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pts1</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pts2</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">points_3d</span> <span class="o">=</span> <span class="n">points_4d</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">points_4d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># Add to map
</span>        <span class="n">self</span><span class="p">.</span><span class="n">map_points</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">points_3d</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">publish_pose</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="n">pose_msg</span> <span class="o">=</span> <span class="nc">PoseStamped</span><span class="p">()</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        
        <span class="c1"># Convert pose matrix to ROS message
</span>        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># Convert rotation matrix to quaternion
</span>        <span class="kn">from</span> <span class="n">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Rotation</span><span class="p">.</span><span class="nf">from_matrix</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">as_quat</span><span class="p">()</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pose_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pose_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">pose_msg</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">slam</span> <span class="o">=</span> <span class="nc">VisualSLAM</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
</code></pre></div></div> <h3 id="multi-sensor-fusion-with-particle-filter"> <a href="#multi-sensor-fusion-with-particle-filter" class="anchor-heading" aria-labelledby="multi-sensor-fusion-with-particle-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Multi-Sensor Fusion with Particle Filter </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# particle_filter.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Imu</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">NavState</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">PoseWithCovariance</span>

<span class="k">class</span> <span class="nc">ParticleFilter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">num_particles</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">particle_filter</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span> <span class="o">=</span> <span class="n">num_particles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">num_particles</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># [x, y, z, roll, pitch, yaw]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">num_particles</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_particles</span>
        
        <span class="c1"># Initialize particles with random distribution
</span>        <span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">num_particles</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="n">num_particles</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        
        <span class="c1"># Process and measurement noise
</span>        <span class="n">self</span><span class="p">.</span><span class="n">process_noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state_pf</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/imu/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/dvl/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_callback</span><span class="p">)</span>
        
        <span class="c1"># Timer for prediction step
</span>        <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">predict_step</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">predict_step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># Prediction step: add process noise
</span>        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">process_noise</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">particles</span> <span class="o">+=</span> <span class="n">noise</span>
        
        <span class="c1"># Normalize angles
</span>        <span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mod</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">publish_state</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">imu_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Update step with IMU measurements
</span>        <span class="n">measured_accel</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> 
                                  <span class="n">msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> 
                                  <span class="n">msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">z</span><span class="p">])</span>
        
        <span class="c1"># Compute likelihood for each particle
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">):</span>
            <span class="c1"># Predict acceleration based on particle orientation
</span>            <span class="n">predicted_accel</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict_acceleration</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="c1"># Compute likelihood
</span>            <span class="n">diff</span> <span class="o">=</span> <span class="n">measured_accel</span> <span class="o">-</span> <span class="n">predicted_accel</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">diff</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">imu_noise</span><span class="p">)</span> <span class="o">@</span> <span class="n">diff</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">likelihood</span>
        
        <span class="c1"># Normalize weights
</span>        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">)</span>
        
        <span class="c1"># Resample if effective sample size is low
</span>        <span class="k">if</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">resample</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">dvl_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Update step with DVL measurements
</span>        <span class="n">measured_velocity</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">msg</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">z</span><span class="p">])</span>
        
        <span class="c1"># Update particles based on DVL measurement
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">):</span>
            <span class="c1"># Predict velocity based on particle state
</span>            <span class="n">predicted_velocity</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict_velocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="c1"># Compute likelihood
</span>            <span class="n">diff</span> <span class="o">=</span> <span class="n">measured_velocity</span> <span class="o">-</span> <span class="n">predicted_velocity</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">diff</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dvl_noise</span><span class="p">)</span> <span class="o">@</span> <span class="n">diff</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">likelihood</span>
        
        <span class="c1"># Normalize weights
</span>        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">)</span>
        
        <span class="c1"># Resample if needed
</span>        <span class="k">if</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">resample</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">predict_acceleration</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">):</span>
        <span class="c1"># Predict acceleration based on particle orientation
</span>        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">particle</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        
        <span class="c1"># Gravity vector in body frame
</span>        <span class="n">R</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">euler_to_rotation_matrix</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span>
        <span class="n">gravity_world</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">9.81</span><span class="p">])</span>
        <span class="n">gravity_body</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">gravity_world</span>
        
        <span class="k">return</span> <span class="n">gravity_body</span>
    
    <span class="k">def</span> <span class="nf">predict_velocity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">):</span>
        <span class="c1"># Simple velocity prediction (can be enhanced with motion model)
</span>        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">euler_to_rotation_matrix</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="c1"># Convert Euler angles to rotation matrix
</span>        <span class="n">cr</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span>
        <span class="n">cp</span><span class="p">,</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">cy</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">cy</span><span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="n">cy</span><span class="o">*</span><span class="n">sp</span><span class="o">*</span><span class="n">sr</span> <span class="o">-</span> <span class="n">sy</span><span class="o">*</span><span class="n">cr</span><span class="p">,</span> <span class="n">cy</span><span class="o">*</span><span class="n">sp</span><span class="o">*</span><span class="n">cr</span> <span class="o">+</span> <span class="n">sy</span><span class="o">*</span><span class="n">sr</span><span class="p">],</span>
            <span class="p">[</span><span class="n">sy</span><span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="n">sy</span><span class="o">*</span><span class="n">sp</span><span class="o">*</span><span class="n">sr</span> <span class="o">+</span> <span class="n">cy</span><span class="o">*</span><span class="n">cr</span><span class="p">,</span> <span class="n">sy</span><span class="o">*</span><span class="n">sp</span><span class="o">*</span><span class="n">cr</span> <span class="o">-</span> <span class="n">cy</span><span class="o">*</span><span class="n">sr</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="o">*</span><span class="n">sr</span><span class="p">,</span> <span class="n">cp</span><span class="o">*</span><span class="n">cr</span><span class="p">]</span>
        <span class="p">])</span>
        
        <span class="k">return</span> <span class="n">R</span>
    
    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Systematic resampling
</span>        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_particles</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">num_particles</span>
    
    <span class="k">def</span> <span class="nf">publish_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Compute weighted mean of particles
</span>        <span class="n">mean_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">average</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Compute covariance
</span>        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cov</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">particles</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aweights</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">)</span>
        
        <span class="c1"># Publish navigation state
</span>        <span class="n">nav_msg</span> <span class="o">=</span> <span class="nc">NavState</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">"</span><span class="s">odom</span><span class="sh">"</span>
        
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">mean_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">mean_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">mean_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Convert Euler to quaternion
</span>        <span class="kn">from</span> <span class="n">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_from_euler</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nf">quaternion_from_euler</span><span class="p">(</span><span class="n">mean_state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mean_state</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mean_state</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># Set covariance
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">cov</span><span class="p">.</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">nav_msg</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="nc">ParticleFilter</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
</code></pre></div></div> <h3 id="real-time-optimization"> <a href="#real-time-optimization" class="anchor-heading" aria-labelledby="real-time-optimization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Real-Time Optimization </h3> <h4 id="model-predictive-control-mpc"> <a href="#model-predictive-control-mpc" class="anchor-heading" aria-labelledby="model-predictive-control-mpc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Model Predictive Control (MPC) </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# mpc_controller.py
</span><span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cvxpy</span> <span class="k">as</span> <span class="n">cp</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">ThrusterCommand</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Wrench</span>

<span class="k">class</span> <span class="nc">MPCController</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">mpc_controller</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># MPC parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Prediction horizon
</span>        <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>      <span class="c1"># Time step
</span>        
        <span class="c1"># State and input dimensions
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nx</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># [x, y, z, roll, pitch, yaw, vx, vy, vz, wx, wy, wz]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mi">6</span>   <span class="c1"># [Fx, Fy, Fz, Tx, Ty, Tz]
</span>        
        <span class="c1"># Vehicle parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">mass</span> <span class="o">=</span> <span class="mf">50.0</span>  <span class="c1"># kg
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inertia</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">])</span>  <span class="c1"># kg*m^2
</span>        
        <span class="c1"># Cost matrices
</span>        <span class="n">self</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># State cost
</span>        <span class="n">self</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># Input cost
</span>        <span class="n">self</span><span class="p">.</span><span class="n">Qf</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">Q</span>  <span class="c1"># Terminal cost
</span>        
        <span class="c1"># Constraints
</span>        <span class="n">self</span><span class="p">.</span><span class="n">u_max</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>  <span class="c1"># Max forces/torques
</span>        <span class="n">self</span><span class="p">.</span><span class="n">u_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">u_max</span>
        
        <span class="c1"># Current state and reference
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">nx</span><span class="p">)</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">wrench_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/wrench_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">Wrench</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nav_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">nav_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cmd_callback</span><span class="p">)</span>
        
        <span class="c1"># Control timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_step</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">nav_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Extract state from navigation message
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span>
        
        <span class="c1"># Convert quaternion to Euler angles
</span>        <span class="kn">from</span> <span class="n">tf.transformations</span> <span class="kn">import</span> <span class="n">euler_from_quaternion</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
             <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span><span class="p">]</span>
        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="nf">euler_from_quaternion</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span>
    
    <span class="k">def</span> <span class="nf">cmd_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Extract reference from command
</span>        <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span>
        
        <span class="c1"># Convert quaternion to Euler angles
</span>        <span class="kn">from</span> <span class="n">tf.transformations</span> <span class="kn">import</span> <span class="n">euler_from_quaternion</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
             <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span><span class="p">]</span>
        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="nf">euler_from_quaternion</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">]</span>
        
        <span class="c1"># Zero velocity reference
</span>        <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">control_step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># Solve MPC optimization problem
</span>        <span class="n">u_opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">solve_mpc</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">u_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Publish control command
</span>            <span class="n">wrench_msg</span> <span class="o">=</span> <span class="nc">Wrench</span><span class="p">()</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">wrench_msg</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">u_opt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">wrench_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">wrench_msg</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">solve_mpc</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Define optimization variables
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Variable</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">horizon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Variable</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">horizon</span><span class="p">))</span>
        
        <span class="c1"># Cost function
</span>        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Initial condition
</span>        <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">current_state</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">horizon</span><span class="p">):</span>
            <span class="c1"># Stage cost
</span>            <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">R</span><span class="p">)</span>
            
            <span class="c1"># Dynamics constraints
</span>            <span class="n">x_next</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_next</span><span class="p">)</span>
            
            <span class="c1"># Input constraints
</span>            <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">u_min</span><span class="p">)</span>
            <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">u_max</span><span class="p">)</span>
        
        <span class="c1"># Terminal cost
</span>        <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">self</span><span class="p">.</span><span class="n">horizon</span><span class="p">]</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">Qf</span><span class="p">)</span>
        
        <span class="c1"># Solve optimization problem
</span>        <span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Problem</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="nc">Minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">problem</span><span class="p">.</span><span class="nf">solve</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="n">cp</span><span class="p">.</span><span class="n">OSQP</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">problem</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="p">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">].</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">MPC solver status: </span><span class="si">{</span><span class="n">problem</span><span class="p">.</span><span class="n">status</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">MPC solver error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">dynamics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="c1"># Simplified 6-DOF dynamics
</span>        <span class="n">pos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">euler</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">vel_linear</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">vel_angular</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
        
        <span class="n">force</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">torque</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        
        <span class="c1"># Linear acceleration
</span>        <span class="n">accel_linear</span> <span class="o">=</span> <span class="n">force</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">mass</span>
        
        <span class="c1"># Angular acceleration
</span>        <span class="n">accel_angular</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inertia</span><span class="p">)</span> <span class="o">@</span> <span class="n">torque</span>
        
        <span class="c1"># Euler angle rates (simplified)
</span>        <span class="n">euler_rates</span> <span class="o">=</span> <span class="n">vel_angular</span>
        
        <span class="c1"># State derivative
</span>        <span class="n">x_dot</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">vstack</span><span class="p">([</span>
            <span class="n">vel_linear</span><span class="p">,</span>
            <span class="n">euler_rates</span><span class="p">,</span>
            <span class="n">accel_linear</span><span class="p">,</span>
            <span class="n">accel_angular</span>
        <span class="p">])</span>
        
        <span class="c1"># Euler integration
</span>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">x_dot</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">mpc</span> <span class="o">=</span> <span class="nc">MPCController</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
</code></pre></div></div> <h2 id="next-steps"> <a href="#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <p>After completing these tutorials:</p> <ol> <li><strong>Explore <a href="examples.md">Examples</a></strong> for more complex scenarios</li> <li><strong>Review <a href="api.md">API Documentation</a></strong> for development</li> <li><strong>Contribute</strong> to the project by submitting improvements</li> <li><strong>Join the community</strong> for support and collaboration</li> </ol> <p>For more advanced topics, consider:</p> <ul> <li>Multi-vehicle coordination</li> <li>Machine learning integration</li> <li>Custom sensor development</li> <li>Real-time optimization techniques</li> </ul> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2024 Jiaxi Zheng. Distributed by an <a href="https://github.com/jiaxi-zheng/ModCube.github.io/tree/main/LICENSE">MIT license.</a></p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
