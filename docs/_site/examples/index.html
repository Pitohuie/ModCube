<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/ModCube.github.io/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/ModCube.github.io/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/ModCube.github.io/assets/js/vendor/lunr.min.js"></script> <script src="/ModCube.github.io/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Examples | RS-ModCubes</title> <meta name="generator" content="Jekyll v4.3.4" /> <meta property="og:title" content="Examples" /> <meta name="author" content="Jiaxi Zheng" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations" /> <meta property="og:description" content="Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations" /> <link rel="canonical" href="http://0.0.0.0:4000/ModCube.github.io/examples/" /> <meta property="og:url" content="http://0.0.0.0:4000/ModCube.github.io/examples/" /> <meta property="og:site_name" content="RS-ModCubes" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Examples" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Jiaxi Zheng"},"description":"Self-Reconfigurable, Scalable Modular Cubic Robots for Underwater Operations","headline":"Examples","url":"http://0.0.0.0:4000/ModCube.github.io/examples/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/ModCube.github.io/" class="site-title lh-tight"> RS-ModCubes </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/ModCube.github.io/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/ModCube.github.io/architecture/" class="nav-list-link">System Architecture</a></li><li class="nav-list-item"><a href="/ModCube.github.io/tutorials/" class="nav-list-link">Tutorials</a></li><li class="nav-list-item"><a href="/ModCube.github.io/api/" class="nav-list-link">API Documentation</a></li><li class="nav-list-item"><a href="/ModCube.github.io/examples/" class="nav-list-link">Examples</a></li><li class="nav-list-item"><a href="/ModCube.github.io/installation/" class="nav-list-link">Installation Guide</a></li><li class="nav-list-item"><a href="/ModCube.github.io/faq/" class="nav-list-link">FAQ</a></li><li class="nav-list-item"><a href="/ModCube.github.io/contributing/" class="nav-list-link">Contributing</a></li><li class="nav-list-item"><a href="/ModCube.github.io/changelog/" class="nav-list-link">Changelog</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/jiaxi-zheng/ModCube.github.io" class="nav-list-link external" > GitHub Repository <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RS-ModCubes" aria-label="Search RS-ModCubes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="examples"> <a href="#examples" class="anchor-heading" aria-labelledby="examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Examples </h1> <p>This section provides practical examples and use cases for the RS-ModCubes system, demonstrating various capabilities from basic operations to advanced applications.</p> <h2 id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h2> <ol> <li><a href="#basic-operations">Basic Operations</a></li> <li><a href="#navigation-examples">Navigation Examples</a></li> <li><a href="#mission-planning">Mission Planning</a></li> <li><a href="#sensor-integration">Sensor Integration</a></li> <li><a href="#multi-vehicle-coordination">Multi-Vehicle Coordination</a></li> <li><a href="#advanced-applications">Advanced Applications</a></li> <li><a href="#custom-development">Custom Development</a></li> </ol> <h2 id="basic-operations"> <a href="#basic-operations" class="anchor-heading" aria-labelledby="basic-operations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Operations </h2> <h3 id="example-1-simple-position-control"> <a href="#example-1-simple-position-control" class="anchor-heading" aria-labelledby="example-1-simple-position-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 1: Simple Position Control </h3> <p>This example demonstrates basic position control of the ModCube vehicle.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Basic Position Control Example

This script demonstrates how to control the ModCube vehicle to move
to specific positions in 3D space.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span>

<span class="k">class</span> <span class="nc">BasicPositionController</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">basic_position_controller</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Publisher for controller commands
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span> 
                                     <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Wait for publisher to be ready
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">goto_position</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">yaw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Move to specified position with optional yaw angle.</span><span class="sh">"""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ControllerCommand</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">odom</span><span class="sh">'</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Position control mode
</span>        
        <span class="c1"># Set target position
</span>        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        
        <span class="c1"># Convert yaw to quaternion
</span>        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        
        <span class="c1"># Publish command
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Moving to position: (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s">) with yaw: </span><span class="si">{</span><span class="n">yaw</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert yaw angle to quaternion.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">math</span>
        <span class="k">return</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">w</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_demo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Run a demonstration sequence.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting basic position control demo</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Define waypoints
</span>        <span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># Start position
</span>            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># Move forward
</span>            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.57</span><span class="p">),</span>   <span class="c1"># Move right and turn
</span>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">),</span>   <span class="c1"># Move back and turn
</span>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># Return to start
</span>        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">goto_position</span><span class="p">(</span><span class="n">wp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Wait 10 seconds at each waypoint
</span>        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Demo completed</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="nc">BasicPositionController</span><span class="p">()</span>
        <span class="n">controller</span><span class="p">.</span><span class="nf">run_demo</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-2-velocity-control"> <a href="#example-2-velocity-control" class="anchor-heading" aria-labelledby="example-2-velocity-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 2: Velocity Control </h3> <p>This example shows how to control the vehicle using velocity commands.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Velocity Control Example

Demonstrates velocity-based control for smooth motion patterns.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Vector3</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span>

<span class="k">class</span> <span class="nc">VelocityController</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">velocity_controller</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span>
                                     <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_velocity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">wx</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wz</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Set linear and angular velocities.</span><span class="sh">"""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ControllerCommand</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">base_link</span><span class="sh">'</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Velocity control mode
</span>        
        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">linear</span> <span class="o">=</span> <span class="nc">Vector3</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">angular</span> <span class="o">=</span> <span class="nc">Vector3</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">circle_pattern</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute a circular motion pattern.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Starting circular pattern: radius=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s">m, speed=</span><span class="si">{</span><span class="n">speed</span><span class="si">}</span><span class="s">m/s</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Rate</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 Hz
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="nf">while </span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">).</span><span class="nf">to_sec</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">:</span>
            <span class="c1"># Calculate angular velocity for circular motion
</span>            <span class="n">angular_vel</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">/</span> <span class="n">radius</span>
            
            <span class="c1"># Set forward velocity and yaw rate
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">set_velocity</span><span class="p">(</span><span class="n">vx</span><span class="o">=</span><span class="n">speed</span><span class="p">,</span> <span class="n">vy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vz</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wz</span><span class="o">=</span><span class="n">angular_vel</span><span class="p">)</span>
            
            <span class="n">rate</span><span class="p">.</span><span class="nf">sleep</span><span class="p">()</span>
        
        <span class="c1"># Stop motion
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">set_velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Circular pattern completed</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">figure_eight</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute a figure-eight pattern.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Starting figure-eight pattern: size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">m, speed=</span><span class="si">{</span><span class="n">speed</span><span class="si">}</span><span class="s">m/s</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Rate</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 20 Hz
</span>        
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cycles</span><span class="p">):</span>
            <span class="c1"># Each cycle takes 2π seconds
</span>            <span class="n">cycle_duration</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">size</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">cycle_duration</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># 20 Hz
</span>            
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">step</span> <span class="o">/</span> <span class="mf">20.0</span>  <span class="c1"># Time in seconds
</span>                
                <span class="c1"># Figure-eight parametric equations
</span>                <span class="n">vx</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">vy</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">wz</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">size</span><span class="p">))</span> <span class="o">/</span> <span class="n">size</span>
                
                <span class="n">self</span><span class="p">.</span><span class="nf">set_velocity</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
                <span class="n">rate</span><span class="p">.</span><span class="nf">sleep</span><span class="p">()</span>
        
        <span class="c1"># Stop motion
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">set_velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Figure-eight pattern completed</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="nc">VelocityController</span><span class="p">()</span>
        
        <span class="c1"># Execute different patterns
</span>        <span class="n">controller</span><span class="p">.</span><span class="nf">circle_pattern</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        
        <span class="n">controller</span><span class="p">.</span><span class="nf">figure_eight</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="navigation-examples"> <a href="#navigation-examples" class="anchor-heading" aria-labelledby="navigation-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Navigation Examples </h2> <h3 id="example-3-waypoint-navigation-with-obstacle-avoidance"> <a href="#example-3-waypoint-navigation-with-obstacle-avoidance" class="anchor-heading" aria-labelledby="example-3-waypoint-navigation-with-obstacle-avoidance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 3: Waypoint Navigation with Obstacle Avoidance </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Waypoint Navigation with Obstacle Avoidance

Demonstrates autonomous navigation between waypoints while avoiding obstacles.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">PointCloud2</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">NavState</span>
<span class="kn">from</span> <span class="n">modcube_common.motion</span> <span class="kn">import</span> <span class="n">MotionClient</span>
<span class="kn">from</span> <span class="n">modcube_common.planning</span> <span class="kn">import</span> <span class="n">PathPlanner</span>

<span class="k">class</span> <span class="nc">WaypointNavigator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">waypoint_navigator</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Initialize motion client and path planner
</span>        <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span> <span class="o">=</span> <span class="nc">MotionClient</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_planner</span> <span class="o">=</span> <span class="nc">PathPlanner</span><span class="p">()</span>
        
        <span class="c1"># Subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nav_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">nav_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cloud_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pointcloud</span><span class="sh">'</span><span class="p">,</span> <span class="n">PointCloud2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cloud_callback</span><span class="p">)</span>
        
        <span class="c1"># Current state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">obstacles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">nav_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update current pose.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span>
    
    <span class="k">def</span> <span class="nf">cloud_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process point cloud for obstacle detection.</span><span class="sh">"""</span>
        <span class="c1"># Simple obstacle detection (in practice, use more sophisticated methods)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">obstacles</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">extract_obstacles</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">extract_obstacles</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pointcloud</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Extract obstacle positions from point cloud.</span><span class="sh">"""</span>
        <span class="c1"># Simplified obstacle extraction
</span>        <span class="c1"># In practice, use clustering, filtering, etc.
</span>        <span class="n">obstacles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Convert point cloud to numpy array (simplified)
</span>        <span class="c1"># points = pointcloud_to_array(pointcloud)
</span>        <span class="c1"># 
</span>        <span class="c1"># for point in points:
</span>        <span class="c1">#     if self.is_obstacle(point):
</span>        <span class="c1">#         obstacles.append(point)
</span>        
        <span class="k">return</span> <span class="n">obstacles</span>
    
    <span class="k">def</span> <span class="nf">navigate_waypoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">waypoints</span><span class="p">,</span> <span class="n">avoid_obstacles</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Navigate through a list of waypoints.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Starting navigation through </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">waypoints</span><span class="p">)</span><span class="si">}</span><span class="s"> waypoints</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">waypoints</span><span class="p">):</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Navigating to waypoint </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">waypoint</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">avoid_obstacles</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">obstacles</span><span class="p">:</span>
                <span class="c1"># Plan path around obstacles
</span>                <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_planner</span><span class="p">.</span><span class="nf">plan_path</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">,</span>
                    <span class="n">goal</span><span class="o">=</span><span class="n">waypoint</span><span class="p">,</span>
                    <span class="n">obstacles</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">obstacles</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">follow_trajectory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">No valid path found, attempting direct navigation</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">waypoint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Direct navigation
</span>                <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">waypoint</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Reached waypoint </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to reach waypoint </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Waypoint navigation completed</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_demo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Run navigation demo.</span><span class="sh">"""</span>
        <span class="c1"># Define waypoints
</span>        <span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">create_pose</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">create_pose</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1.57</span><span class="p">),</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">create_pose</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">),</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">create_pose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.57</span><span class="p">),</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">create_pose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">navigate_waypoints</span><span class="p">(</span><span class="n">waypoints</span><span class="p">,</span> <span class="n">avoid_obstacles</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">create_pose</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Create a pose from position and yaw.</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span>
        <span class="kn">import</span> <span class="n">math</span>
        
        <span class="n">pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">w</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pose</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">navigator</span> <span class="o">=</span> <span class="nc">WaypointNavigator</span><span class="p">()</span>
        <span class="n">navigator</span><span class="p">.</span><span class="nf">run_demo</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-4-dynamic-target-tracking"> <a href="#example-4-dynamic-target-tracking" class="anchor-heading" aria-labelledby="example-4-dynamic-target-tracking"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 4: Dynamic Target Tracking </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Dynamic Target Tracking

Tracks and follows a moving target using visual detection.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">AprilTagDetection</span><span class="p">,</span> <span class="n">ControllerCommand</span>
<span class="kn">from</span> <span class="n">modcube_common.vision</span> <span class="kn">import</span> <span class="n">TargetTracker</span>

<span class="k">class</span> <span class="nc">TargetFollower</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">target_follower</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Target tracking
</span>        <span class="n">self</span><span class="p">.</span><span class="n">target_tracker</span> <span class="o">=</span> <span class="nc">TargetTracker</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">target_position</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Control parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">follow_distance</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># meters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># m/s
</span>        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span>
                                     <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">detection_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/apriltag_detections</span><span class="sh">'</span><span class="p">,</span>
                                            <span class="n">AprilTagDetection</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">detection_callback</span><span class="p">)</span>
        
        <span class="c1"># Control timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_callback</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Target follower initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">detection_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process target detection.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="nb">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Follow AprilTag with ID 1
</span>            <span class="c1"># Update target position
</span>            <span class="n">self</span><span class="p">.</span><span class="n">target_position</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span>
            
            <span class="c1"># Estimate target velocity (simple differentiation)
</span>            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">last_target_pos</span><span class="sh">'</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">last_detection_time</span><span class="sh">'</span><span class="p">):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_detection_time</span><span class="p">).</span><span class="nf">to_sec</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_target_pos</span><span class="p">.</span><span class="n">x</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_target_pos</span><span class="p">.</span><span class="n">y</span>
                    <span class="n">dz</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_target_pos</span><span class="p">.</span><span class="n">z</span>
                    
                    <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">dx</span> <span class="o">/</span> <span class="n">dt</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">dy</span> <span class="o">/</span> <span class="n">dt</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">dz</span> <span class="o">/</span> <span class="n">dt</span>
                    <span class="p">)</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">last_target_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span>
            <span class="n">self</span><span class="p">.</span><span class="n">last_detection_time</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span>
    
    <span class="k">def</span> <span class="nf">control_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main control loop.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Predict target future position
</span>        <span class="n">prediction_time</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># seconds
</span>        <span class="n">predicted_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict_target_position</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span>
        
        <span class="c1"># Calculate desired following position
</span>        <span class="n">follow_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_follow_position</span><span class="p">(</span><span class="n">predicted_pos</span><span class="p">)</span>
        
        <span class="c1"># Generate control command
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_control_command</span><span class="p">(</span><span class="n">follow_pos</span><span class="p">)</span>
        
        <span class="c1"># Publish command
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_target_position</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Predict target position after time dt.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span>
        
        <span class="n">predicted</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">predicted</span>
    
    <span class="k">def</span> <span class="nf">calculate_follow_position</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate desired following position.</span><span class="sh">"""</span>
        <span class="c1"># Follow at a fixed distance behind the target
</span>        <span class="c1"># Assume target is moving in XY plane
</span>        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span> <span class="ow">and</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="c1"># Target is moving, follow behind
</span>            <span class="n">vel_mag</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">vel_unit_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">vel_mag</span>
            <span class="n">vel_unit_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">target_velocity</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">vel_mag</span>
            
            <span class="n">follow_pos</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">vel_unit_x</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">follow_distance</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">vel_unit_y</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">follow_distance</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">z</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Target is stationary, maintain current relative position
</span>            <span class="n">follow_pos</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">follow_distance</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">target_pos</span><span class="p">.</span><span class="n">z</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">follow_pos</span>
    
    <span class="k">def</span> <span class="nf">generate_control_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">desired_pos</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate control command to reach desired position.</span><span class="sh">"""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nc">ControllerCommand</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">odom</span><span class="sh">'</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Position control
</span>        
        <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">desired_pos</span>
        
        <span class="c1"># Face towards target
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">desired_pos</span><span class="p">.</span><span class="n">x</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">target_position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">desired_pos</span><span class="p">.</span><span class="n">y</span>
            <span class="n">yaw</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
            
            <span class="n">cmd</span><span class="p">.</span><span class="n">setpoint</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cmd</span>
    
    <span class="k">def</span> <span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert yaw to quaternion.</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Quaternion</span>
        <span class="k">return</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">w</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">follower</span> <span class="o">=</span> <span class="nc">TargetFollower</span><span class="p">()</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="mission-planning"> <a href="#mission-planning" class="anchor-heading" aria-labelledby="mission-planning"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mission Planning </h2> <h3 id="example-5-search-and-rescue-mission"> <a href="#example-5-search-and-rescue-mission" class="anchor-heading" aria-labelledby="example-5-search-and-rescue-mission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 5: Search and Rescue Mission </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Search and Rescue Mission

Implements a comprehensive search and rescue operation with
pattern search, target detection, and recovery procedures.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">MissionState</span><span class="p">,</span> <span class="n">AprilTagDetection</span>
<span class="kn">from</span> <span class="n">modcube_mission</span> <span class="kn">import</span> <span class="n">BaseMission</span>
<span class="kn">from</span> <span class="n">modcube_common.motion</span> <span class="kn">import</span> <span class="n">MotionClient</span>
<span class="kn">from</span> <span class="n">modcube_common.planning</span> <span class="kn">import</span> <span class="n">SearchPlanner</span>

<span class="k">class</span> <span class="nc">SearchRescueMission</span><span class="p">(</span><span class="n">BaseMission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span> <span class="o">=</span> <span class="nc">MotionClient</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">search_planner</span> <span class="o">=</span> <span class="nc">SearchPlanner</span><span class="p">()</span>
        
        <span class="c1"># Mission parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">search_area</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">min_x</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">max_x</span><span class="sh">'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min_y</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">max_y</span><span class="sh">'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">search_pattern</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lawnmower</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">search_spacing</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">search_speed</span> <span class="o">=</span> <span class="mf">0.5</span>
        
        <span class="c1"># Target detection
</span>        <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_target</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">detection_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/apriltag_detections</span><span class="sh">'</span><span class="p">,</span>
                                            <span class="n">AprilTagDetection</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">detection_callback</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Search and Rescue mission initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">detection_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle target detection.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">]:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">detection_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">confidence</span>
            <span class="p">}</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">New target detected: ID </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s"> at </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute the search and rescue mission.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting Search and Rescue mission</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Phase 1: Search phase
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">searching</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">search_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_search_phase</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 2: Investigation phase
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">investigating</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">investigation_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_investigation_phase</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">investigation_success</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 3: Recovery phase
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">recovering</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">recovery_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_recovery_phase</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery_success</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Mission completed
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">completed</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mission completed. Found </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">)</span><span class="si">}</span><span class="s"> targets.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mission failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">execute_search_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute systematic search of the area.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting search phase</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Generate search pattern
</span>        <span class="n">search_waypoints</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">search_planner</span><span class="p">.</span><span class="nf">generate_pattern</span><span class="p">(</span>
            <span class="n">area</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">search_area</span><span class="p">,</span>
            <span class="n">pattern</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">search_pattern</span><span class="p">,</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">search_spacing</span>
        <span class="p">)</span>
        
        <span class="c1"># Execute search pattern
</span>        <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">search_waypoints</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">waypoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to reach search waypoint: </span><span class="si">{</span><span class="n">waypoint</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Check for early termination if targets found
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Stop after finding 3 targets
</span>                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Sufficient targets found, ending search phase</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Search phase completed. Found </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">)</span><span class="si">}</span><span class="s"> targets.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">execute_investigation_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Investigate detected targets for detailed analysis.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting investigation phase</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Investigating target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Move closer to target for detailed inspection
</span>            <span class="n">investigation_pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_investigation_pose</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">investigation_pose</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># Perform detailed inspection
</span>                <span class="n">inspection_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">perform_inspection</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">inspection_result</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspection_result</span>
                
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> inspection completed</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to investigate target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">execute_recovery_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute recovery operations for confirmed targets.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting recovery phase</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Prioritize targets based on investigation results
</span>        <span class="n">priority_targets</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prioritize_targets</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">priority_targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">inspection_result</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">requires_recovery</span><span class="sh">'</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Executing recovery for target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                
                <span class="n">recovery_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_target_recovery</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">recovery_success</span><span class="p">:</span>
                    <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">recovered</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> successfully recovered</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to recover target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">calculate_investigation_pose</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate optimal pose for target investigation.</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span>
        <span class="kn">import</span> <span class="n">math</span>
        
        <span class="c1"># Position 2 meters away from target
</span>        <span class="n">investigation_distance</span> <span class="o">=</span> <span class="mf">2.0</span>
        
        <span class="n">pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">investigation_distance</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">.</span><span class="n">y</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">.</span><span class="n">z</span>
        
        <span class="c1"># Face towards target
</span>        <span class="n">yaw</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">target_pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pose</span>
    
    <span class="k">def</span> <span class="nf">perform_inspection</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform detailed inspection of target.</span><span class="sh">"""</span>
        <span class="c1"># Simulate inspection process
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>  <span class="c1"># Inspection time
</span>        
        <span class="c1"># Mock inspection results
</span>        <span class="n">inspection_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">target_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">survivor</span><span class="sh">'</span> <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sh">'</span><span class="s">debris</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">condition</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">good</span><span class="sh">'</span> <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="k">else</span> <span class="sh">'</span><span class="s">poor</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">requires_recovery</span><span class="sh">'</span><span class="p">:</span> <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">inspection_result</span>
    
    <span class="k">def</span> <span class="nf">prioritize_targets</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Prioritize targets based on inspection results.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">targets_found</span><span class="p">,</span> 
                     <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">inspection_result</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                     <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute_target_recovery</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute recovery operation for a specific target.</span><span class="sh">"""</span>
        <span class="c1"># Simulate recovery operation
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Deploying recovery mechanism for target </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Move to recovery position
</span>        <span class="n">recovery_pose</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">recovery_pose</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="c1"># Simulate recovery actions
</span>            <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># Recovery time
</span>            <span class="k">return</span> <span class="bp">True</span>
        
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mission</span> <span class="o">=</span> <span class="nc">SearchRescueMission</span><span class="p">()</span>
        <span class="n">mission</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-6-autonomous-inspection-mission"> <a href="#example-6-autonomous-inspection-mission" class="anchor-heading" aria-labelledby="example-6-autonomous-inspection-mission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 6: Autonomous Inspection Mission </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Autonomous Inspection Mission

Performs detailed inspection of underwater structures using
computer vision and structured data collection.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">PointCloud2</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">InspectionReport</span>
<span class="kn">from</span> <span class="n">modcube_mission</span> <span class="kn">import</span> <span class="n">BaseMission</span>
<span class="kn">from</span> <span class="n">modcube_common.vision</span> <span class="kn">import</span> <span class="n">DefectDetector</span>
<span class="kn">from</span> <span class="n">modcube_common.motion</span> <span class="kn">import</span> <span class="n">MotionClient</span>
<span class="kn">from</span> <span class="n">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span>

<span class="k">class</span> <span class="nc">InspectionMission</span><span class="p">(</span><span class="n">BaseMission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span> <span class="o">=</span> <span class="nc">MotionClient</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">defect_detector</span> <span class="o">=</span> <span class="nc">DefectDetector</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        
        <span class="c1"># Inspection parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># meters from structure
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_speed</span> <span class="o">=</span> <span class="mf">0.2</span>     <span class="c1"># m/s
</span>        <span class="n">self</span><span class="p">.</span><span class="n">image_capture_rate</span> <span class="o">=</span> <span class="mf">2.0</span>   <span class="c1"># Hz
</span>        
        <span class="c1"># Data collection
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">report_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/inspection_report</span><span class="sh">'</span><span class="p">,</span> 
                                        <span class="n">InspectionReport</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span> 
                                        <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pointcloud_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pointcloud</span><span class="sh">'</span><span class="p">,</span> 
                                             <span class="n">PointCloud2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pointcloud_callback</span><span class="p">)</span>
        
        <span class="c1"># Image capture timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">capture_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">image_capture_rate</span><span class="p">),</span> 
                                       <span class="n">self</span><span class="p">.</span><span class="n">capture_callback</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process incoming images for defect detection.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">bgr8</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Detect defects in image
</span>            <span class="n">defects</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">defect_detector</span><span class="p">.</span><span class="nf">detect_defects</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">defects</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">process_defects</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Image processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pointcloud_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process point cloud data for 3D structure analysis.</span><span class="sh">"""</span>
        <span class="c1"># Extract 3D structure information
</span>        <span class="n">structure_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">analyze_structure_3d</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Store for inspection report
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">structure_data</span><span class="sh">'</span><span class="p">:</span> <span class="n">structure_data</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">capture_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Periodic data capture during inspection.</span><span class="sh">"""</span>
        <span class="c1"># Capture current pose and sensor data
</span>        <span class="n">current_pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">get_current_pose</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">current_pose</span><span class="p">:</span>
            <span class="n">inspection_point</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
                <span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_pose</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">data_captured</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span>
            <span class="p">}</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">inspection_point</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute the inspection mission.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting autonomous inspection mission</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Phase 1: Structure approach
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">approaching</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">approach_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">approach_structure</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">approach_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 2: Systematic inspection
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">inspecting</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">inspection_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_inspection_pattern</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inspection_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 3: Detailed defect analysis
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">analyzing</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">analysis_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">analyze_defects</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_success</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 4: Report generation
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">reporting</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">generate_inspection_report</span><span class="p">()</span>
            
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">completed</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission completed successfully</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Inspection mission failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">approach_structure</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Approach the structure to be inspected.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Approaching inspection structure</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Define approach waypoints
</span>        <span class="n">approach_poses</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_approach_trajectory</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">approach_poses</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to reach approach waypoint</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">execute_inspection_pattern</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute systematic inspection pattern.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing inspection pattern</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Generate inspection trajectory
</span>        <span class="n">inspection_trajectory</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_inspection_trajectory</span><span class="p">()</span>
        
        <span class="c1"># Follow trajectory at inspection speed
</span>        <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">follow_trajectory</span><span class="p">(</span>
            <span class="n">trajectory</span><span class="o">=</span><span class="n">inspection_trajectory</span><span class="p">,</span>
            <span class="n">speed</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_speed</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">success</span>
    
    <span class="k">def</span> <span class="nf">generate_approach_trajectory</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate trajectory for approaching the structure.</span><span class="sh">"""</span>
        <span class="c1"># Simplified approach trajectory
</span>        <span class="n">approach_poses</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Start position (10m away)
</span>        <span class="n">start_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">start_pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">start_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">approach_poses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">start_pose</span><span class="p">)</span>
        
        <span class="c1"># Intermediate position (5m away)
</span>        <span class="n">mid_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">mid_pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">mid_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">approach_poses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">mid_pose</span><span class="p">)</span>
        
        <span class="c1"># Final approach position
</span>        <span class="n">final_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">final_pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">final_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">approach_poses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">final_pose</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">approach_poses</span>
    
    <span class="k">def</span> <span class="nf">generate_inspection_trajectory</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate systematic inspection trajectory.</span><span class="sh">"""</span>
        <span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Vertical scanning pattern
</span>        <span class="n">x_pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span>
        <span class="n">z_start</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">z_end</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.0</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        
        <span class="c1"># Generate zigzag pattern
</span>        <span class="n">z_positions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">z_start</span><span class="p">,</span> <span class="n">z_end</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">z_positions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Even rows: left to right
</span>                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Odd rows: right to left
</span>                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_positions</span><span class="p">:</span>
                <span class="n">pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">trajectory</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">trajectory</span>
    
    <span class="k">def</span> <span class="nf">process_defects</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">defects</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process detected defects.</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">defects</span><span class="p">:</span>
            <span class="n">defect_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">:</span> <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">image_coords</span><span class="sh">'</span><span class="p">:</span> <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">defect_info</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Defect detected: </span><span class="si">{</span><span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> (severity: </span><span class="si">{</span><span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">analyze_structure_3d</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pointcloud</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Analyze 3D structure from point cloud.</span><span class="sh">"""</span>
        <span class="c1"># Simplified 3D analysis
</span>        <span class="n">structure_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">point_count</span><span class="sh">'</span><span class="p">:</span> <span class="n">pointcloud</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">pointcloud</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">density</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># Simplified
</span>            <span class="sh">'</span><span class="s">surface_roughness</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Mock value
</span>            <span class="sh">'</span><span class="s">geometric_features</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">planar</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cylindrical</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">structure_data</span>
    
    <span class="k">def</span> <span class="nf">analyze_defects</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform detailed analysis of detected defects.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Analyzing </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">)</span><span class="si">}</span><span class="s"> detected defects</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">:</span>
            <span class="c1"># Move closer to defect for detailed inspection
</span>            <span class="n">detailed_pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_detailed_inspection_pose</span><span class="p">(</span><span class="n">defect</span><span class="p">)</span>
            
            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">detailed_pose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># Perform detailed analysis
</span>                <span class="n">detailed_analysis</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">perform_detailed_defect_analysis</span><span class="p">(</span><span class="n">defect</span><span class="p">)</span>
                <span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">detailed_analysis</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">detailed_analysis</span>
        
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">calculate_detailed_inspection_pose</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">defect</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate pose for detailed defect inspection.</span><span class="sh">"""</span>
        <span class="c1"># Move closer to defect location
</span>        <span class="n">pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Very close to structure
</span>            <span class="n">y</span><span class="o">=</span><span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">z</span><span class="o">=</span><span class="n">defect</span><span class="p">[</span><span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
        
        <span class="k">return</span> <span class="n">pose</span>
    
    <span class="k">def</span> <span class="nf">perform_detailed_defect_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">defect</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform detailed analysis of a specific defect.</span><span class="sh">"""</span>
        <span class="c1"># Simulate detailed analysis
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
        
        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">dimensions</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">length</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">material_loss</span><span class="sh">'</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>  <span class="c1"># percentage
</span>            <span class="sh">'</span><span class="s">corrosion_rate</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># mm/year
</span>            <span class="sh">'</span><span class="s">repair_urgency</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recommended_action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">monitor</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">analysis</span>
    
    <span class="k">def</span> <span class="nf">generate_inspection_report</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate comprehensive inspection report.</span><span class="sh">"""</span>
        <span class="n">report</span> <span class="o">=</span> <span class="nc">InspectionReport</span><span class="p">()</span>
        <span class="n">report</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">report</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">inspection_report</span><span class="sh">'</span>
        
        <span class="c1"># Summary statistics
</span>        <span class="n">report</span><span class="p">.</span><span class="n">total_defects</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">)</span>
        <span class="n">report</span><span class="p">.</span><span class="n">inspection_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">start_time</span><span class="p">).</span><span class="nf">to_sec</span><span class="p">()</span>
        <span class="n">report</span><span class="p">.</span><span class="n">area_covered</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_inspection_area</span><span class="p">()</span>
        
        <span class="c1"># Defect summary
</span>        <span class="n">report</span><span class="p">.</span><span class="n">critical_defects</span> <span class="o">=</span> <span class="nf">len</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">critical</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">report</span><span class="p">.</span><span class="n">major_defects</span> <span class="o">=</span> <span class="nf">len</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">report</span><span class="p">.</span><span class="n">minor_defects</span> <span class="o">=</span> <span class="nf">len</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">minor</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># Recommendations
</span>        <span class="n">report</span><span class="p">.</span><span class="n">recommendations</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_recommendations</span><span class="p">()</span>
        
        <span class="c1"># Publish report
</span>        <span class="n">self</span><span class="p">.</span><span class="n">report_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        
        <span class="c1"># Save detailed report to file
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">save_detailed_report</span><span class="p">()</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection report generated and published</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_inspection_area</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate total area inspected.</span><span class="sh">"""</span>
        <span class="c1"># Simplified area calculation
</span>        <span class="k">return</span> <span class="mf">25.0</span>  <span class="c1"># square meters
</span>    
    <span class="k">def</span> <span class="nf">generate_recommendations</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate maintenance recommendations.</span><span class="sh">"""</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">critical_defects</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">critical</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">critical_defects</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Immediate repair required for critical defects</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">major_defects</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">major_defects</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Schedule maintenance for major defects within 30 days</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Consider comprehensive structural assessment</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">save_detailed_report</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save detailed inspection report to file.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="kn">import</span> <span class="n">os</span>
        
        <span class="n">report_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">mission_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mission_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">to_sec</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">defects</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">inspection_data</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">total_defects</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">defects_found</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">area_covered</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_inspection_area</span><span class="p">(),</span>
                <span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_recommendations</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1"># Save to file
</span>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">inspection_report_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">mission_id</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">to_sec</span><span class="p">())</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">/tmp</span><span class="sh">'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">report_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Detailed report saved to: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mission</span> <span class="o">=</span> <span class="nc">InspectionMission</span><span class="p">()</span>
        <span class="n">mission</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-7-multi-robot-coordination"> <a href="#example-7-multi-robot-coordination" class="anchor-heading" aria-labelledby="example-7-multi-robot-coordination"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 7: Multi-Robot Coordination </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Multi-Robot Coordination Example

Demonstrates coordinated operation of multiple ModCube vehicles
for complex missions requiring teamwork.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">FleetCommand</span><span class="p">,</span> <span class="n">VehicleState</span><span class="p">,</span> <span class="n">FormationConfig</span>
<span class="kn">from</span> <span class="n">modcube_common.coordination</span> <span class="kn">import</span> <span class="n">FleetManager</span><span class="p">,</span> <span class="n">FormationController</span>
<span class="kn">from</span> <span class="n">modcube_common.communication</span> <span class="kn">import</span> <span class="n">InterVehicleComm</span>
<span class="kn">from</span> <span class="n">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">class</span> <span class="nc">MultiRobotCoordinator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">,</span> <span class="n">fleet_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">coordinator_</span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">=</span> <span class="n">vehicle_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fleet_size</span> <span class="o">=</span> <span class="n">fleet_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_leader</span> <span class="o">=</span> <span class="p">(</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Fleet management
</span>        <span class="n">self</span><span class="p">.</span><span class="n">fleet_manager</span> <span class="o">=</span> <span class="nc">FleetManager</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span> <span class="n">fleet_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">formation_controller</span> <span class="o">=</span> <span class="nc">FormationController</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inter_vehicle_comm</span> <span class="o">=</span> <span class="nc">InterVehicleComm</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">)</span>
        
        <span class="c1"># Vehicle state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_velocity</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># States of all vehicles
</span>        
        <span class="c1"># Mission parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">line</span><span class="sh">'</span>  <span class="c1"># line, triangle, diamond
</span>        <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># meters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">/modcube_</span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="s">/cmd_vel</span><span class="sh">'</span><span class="p">,</span> 
                                     <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">state_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/fleet/vehicle_states</span><span class="sh">'</span><span class="p">,</span> 
                                       <span class="n">VehicleState</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">fleet_cmd_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/fleet/commands</span><span class="sh">'</span><span class="p">,</span> 
                                            <span class="n">FleetCommand</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">fleet_command_callback</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_state_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/fleet/vehicle_states</span><span class="sh">'</span><span class="p">,</span> 
                                                <span class="n">VehicleState</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_state_callback</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pose_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">/modcube_</span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="s">/nav_state</span><span class="sh">'</span><span class="p">,</span> 
                                       <span class="n">VehicleState</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pose_callback</span><span class="p">)</span>
        
        <span class="c1"># Inter-vehicle communication
</span>        <span class="n">self</span><span class="p">.</span><span class="n">comm_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/fleet/inter_vehicle_comm</span><span class="sh">'</span><span class="p">,</span> 
                                       <span class="n">String</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">inter_vehicle_callback</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">comm_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/fleet/inter_vehicle_comm</span><span class="sh">'</span><span class="p">,</span> 
                                      <span class="n">String</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Control loop
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_loop</span><span class="p">)</span>
        
        <span class="c1"># State publishing timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">state_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">publish_state</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Multi-robot coordinator initialized for vehicle </span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Leader initialization
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_leader</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">initialize_mission</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">pose_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update current vehicle pose.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_velocity</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">velocity</span>
    
    <span class="k">def</span> <span class="nf">vehicle_state_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update fleet vehicle states.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">vehicle_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">fleet_command_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process fleet-wide commands.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">command_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">formation_change</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">change_formation</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">formation_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="n">command_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">mission_waypoints</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_mission_waypoints</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">waypoints</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="n">command_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">emergency_stop</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">emergency_stop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="n">command_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">formation_spacing</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">spacing</span>
    
    <span class="k">def</span> <span class="nf">inter_vehicle_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process inter-vehicle communication.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comm_data</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Simple parsing, use JSON in production
</span>            
            <span class="k">if</span> <span class="n">comm_data</span><span class="p">[</span><span class="sh">'</span><span class="s">target_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="ow">or</span> <span class="n">comm_data</span><span class="p">[</span><span class="sh">'</span><span class="s">target_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">process_inter_vehicle_message</span><span class="p">(</span><span class="n">comm_data</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to process inter-vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">initialize_mission</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize mission parameters (leader only).</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">is_leader</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Define mission waypoints
</span>        <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">),</span>
            <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">),</span>
            <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">),</span>
            <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">),</span>
            <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># Broadcast initial formation
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">broadcast_formation_config</span><span class="p">()</span>
        
        <span class="c1"># Start mission after delay
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">5.0</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">start_mission</span><span class="p">,</span> <span class="n">oneshot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">broadcast_formation_config</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Broadcast formation configuration to fleet.</span><span class="sh">"""</span>
        <span class="n">formation_config</span> <span class="o">=</span> <span class="nc">FormationConfig</span><span class="p">()</span>
        <span class="n">formation_config</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span>
        <span class="n">formation_config</span><span class="p">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
        <span class="n">formation_config</span><span class="p">.</span><span class="n">leader_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span>
        
        <span class="n">fleet_cmd</span> <span class="o">=</span> <span class="nc">FleetCommand</span><span class="p">()</span>
        <span class="n">fleet_cmd</span><span class="p">.</span><span class="n">command_type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">formation_change</span><span class="sh">'</span>
        <span class="n">fleet_cmd</span><span class="p">.</span><span class="n">formation_config</span> <span class="o">=</span> <span class="n">formation_config</span>
        
        <span class="c1"># Publish via inter-vehicle communication
</span>        <span class="n">comm_msg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">sender_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">target_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">message_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">formation_config</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">formation_type</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">spacing</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">leader_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">comm_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="nc">String</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">comm_msg</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">start_mission</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Start the coordinated mission.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_leader</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting coordinated mission</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Broadcast mission start
</span>            <span class="n">comm_msg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">sender_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">target_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">message_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">mission_start</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">waypoints</span><span class="sh">'</span><span class="p">:</span> <span class="p">[(</span><span class="n">wp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">wp</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">wp</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">comm_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="nc">String</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">comm_msg</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">control_loop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main control loop for coordinated movement.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Calculate desired position based on role
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_leader</span><span class="p">:</span>
            <span class="n">desired_pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_leader_position</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desired_pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_follower_position</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">desired_pose</span><span class="p">:</span>
            <span class="c1"># Generate control command
</span>            <span class="n">cmd_vel</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_control_command</span><span class="p">(</span><span class="n">desired_pose</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd_vel</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_leader_position</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate leader</span><span class="sh">'</span><span class="s">s desired position.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">&gt;=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">target_waypoint</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span><span class="p">]</span>
        
        <span class="c1"># Check if close enough to current waypoint
</span>        <span class="n">distance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_distance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">target_waypoint</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>  <span class="c1"># Within 2 meters
</span>            <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Broadcast waypoint update
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span><span class="p">):</span>
                <span class="n">comm_msg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">sender_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">target_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">message_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">waypoint_update</span><span class="sh">'</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">'</span><span class="s">current_waypoint_idx</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">comm_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="nc">String</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">comm_msg</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Mission completed</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">return</span> <span class="n">target_waypoint</span>
    
    <span class="k">def</span> <span class="nf">calculate_follower_position</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate follower</span><span class="sh">'</span><span class="s">s desired position in formation.</span><span class="sh">"""</span>
        <span class="c1"># Get leader state
</span>        <span class="n">leader_state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">leader_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="c1"># Calculate formation offset
</span>        <span class="n">formation_offset</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_formation_offset</span><span class="p">()</span>
        
        <span class="c1"># Calculate desired position relative to leader
</span>        <span class="n">desired_pose</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">()</span>
        <span class="n">desired_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">leader_state</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">formation_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">desired_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">leader_state</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">formation_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">desired_pose</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">leader_state</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">formation_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">desired_pose</span>
    
    <span class="k">def</span> <span class="nf">calculate_formation_offset</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate formation offset based on vehicle ID and formation type.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">line</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Line formation: vehicles arranged in a line behind leader
</span>            <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
            <span class="n">offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">offset_z</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Triangle formation
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">offset_z</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">diamond</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Diamond formation
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
            <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
                <span class="n">offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">offset_z</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default: line formation
</span>            <span class="n">offset_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span>
            <span class="n">offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">offset_z</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">offset_z</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">calculate_control_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_position</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate control command to reach target position.</span><span class="sh">"""</span>
        <span class="n">cmd_vel</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        
        <span class="c1"># Position error
</span>        <span class="n">error_x</span> <span class="o">=</span> <span class="n">target_position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span>
        <span class="n">error_y</span> <span class="o">=</span> <span class="n">target_position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span>
        <span class="n">error_z</span> <span class="o">=</span> <span class="n">target_position</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span>
        
        <span class="c1"># Simple proportional control
</span>        <span class="n">kp</span> <span class="o">=</span> <span class="mf">0.5</span>
        
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error_x</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error_y</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error_z</span>
        
        <span class="c1"># Limit velocities
</span>        <span class="n">max_vel</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="o">-</span><span class="n">max_vel</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">max_vel</span><span class="p">,</span> <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="o">-</span><span class="n">max_vel</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">max_vel</span><span class="p">,</span> <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="o">-</span><span class="n">max_vel</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">max_vel</span><span class="p">,</span> <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">cmd_vel</span>
    
    <span class="k">def</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate Euclidean distance between two positions.</span><span class="sh">"""</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">.</span><span class="n">x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">.</span><span class="n">y</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">.</span><span class="n">z</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span><span class="o">*</span><span class="n">dy</span> <span class="o">+</span> <span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">change_formation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">formation_config</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Change formation configuration.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">=</span> <span class="n">formation_config</span><span class="p">.</span><span class="n">formation_type</span>
        <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">=</span> <span class="n">formation_config</span><span class="p">.</span><span class="n">spacing</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Formation changed to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">formation_type</span><span class="si">}</span><span class="s"> with spacing </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_mission_waypoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">waypoints</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update mission waypoints.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span> <span class="o">=</span> <span class="n">waypoints</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mission waypoints updated: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">waypoints</span><span class="p">)</span><span class="si">}</span><span class="s"> waypoints</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">emergency_stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute emergency stop.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">Emergency stop activated</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Stop vehicle
</span>        <span class="n">stop_cmd</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">stop_cmd</span><span class="p">)</span>
        
        <span class="c1"># Clear mission waypoints
</span>        <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">process_inter_vehicle_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">comm_data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process inter-vehicle communication messages.</span><span class="sh">"""</span>
        <span class="n">message_type</span> <span class="o">=</span> <span class="n">comm_data</span><span class="p">[</span><span class="sh">'</span><span class="s">message_type</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">comm_data</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">message_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">formation_config</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">formation_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">formation_type</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">formation_spacing</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">spacing</span><span class="sh">'</span><span class="p">]</span>
            
        <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">mission_start</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span><span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">wp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">wp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">waypoints</span><span class="sh">'</span><span class="p">]]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">mission_waypoints</span> <span class="o">=</span> <span class="n">waypoints</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">waypoint_update</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_waypoint_idx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">current_waypoint_idx</span><span class="sh">'</span><span class="p">]</span>
            
        <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">obstacle_detected</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">handle_obstacle_detection</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">formation_adjustment</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">handle_formation_adjustment</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">handle_obstacle_detection</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obstacle_data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle obstacle detection from other vehicles.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Obstacle detected by vehicle </span><span class="si">{</span><span class="n">obstacle_data</span><span class="p">[</span><span class="sh">'</span><span class="s">detector_id</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Implement obstacle avoidance logic
</span>        <span class="c1"># This could involve formation adjustment or path replanning
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">handle_formation_adjustment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">adjustment_data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle formation adjustment requests.</span><span class="sh">"""</span>
        <span class="c1"># Implement dynamic formation adjustment
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">publish_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish current vehicle state to fleet.</span><span class="sh">"""</span>
        <span class="n">state_msg</span> <span class="o">=</span> <span class="nc">VehicleState</span><span class="p">()</span>
        <span class="n">state_msg</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span>
        <span class="n">state_msg</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span>
        <span class="n">state_msg</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_velocity</span>
        <span class="n">state_msg</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">state_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">state_msg</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sh">"</span><span class="s">Usage: multi_robot_coordinator.py &lt;vehicle_id&gt;</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">vehicle_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">coordinator</span> <span class="o">=</span> <span class="nc">MultiRobotCoordinator</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-8-machine-learning-integration"> <a href="#example-8-machine-learning-integration" class="anchor-heading" aria-labelledby="example-8-machine-learning-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 8: Machine Learning Integration </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Machine Learning Integration Example

Demonstrates integration of machine learning models for
autonomous decision making and adaptive behavior.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">PointCloud2</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">MLPrediction</span><span class="p">,</span> <span class="n">BehaviorCommand</span>
<span class="kn">from</span> <span class="n">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="n">pickle</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">class</span> <span class="nc">MLIntegratedController</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">ml_controller</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        
        <span class="c1"># Load pre-trained models
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">load_models</span><span class="p">()</span>
        
        <span class="c1"># Data buffers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">image_buffer</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sensor_buffer</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">action_history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># State variables
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_image</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pointcloud</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># ML parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">prediction_confidence_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">self</span><span class="p">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exploration_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prediction_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/ml_prediction</span><span class="sh">'</span><span class="p">,</span> 
                                            <span class="n">MLPrediction</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span> 
                                        <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pointcloud_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pointcloud</span><span class="sh">'</span><span class="p">,</span> 
                                             <span class="n">PointCloud2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pointcloud_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pose_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> 
                                       <span class="n">Pose</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pose_callback</span><span class="p">)</span>
        
        <span class="c1"># Control loop
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_loop</span><span class="p">)</span>
        
        <span class="c1"># Model update timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">update_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">update_models</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">ML integrated controller initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load pre-trained machine learning models.</span><span class="sh">"""</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">get_param</span><span class="p">(</span><span class="sh">'</span><span class="s">~model_path</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/tmp/modcube_models</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Object detection model
</span>            <span class="n">self</span><span class="p">.</span><span class="n">object_detector</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span>
                <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">object_detector.h5</span><span class="sh">'</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Behavior prediction model
</span>            <span class="n">self</span><span class="p">.</span><span class="n">behavior_predictor</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span>
                <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">behavior_predictor.h5</span><span class="sh">'</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Reinforcement learning policy
</span>            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">rl_policy.pkl</span><span class="sh">'</span><span class="p">),</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">ML models loaded successfully</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to load ML models: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Initialize simple models as fallback
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">initialize_fallback_models</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">initialize_fallback_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize simple fallback models.</span><span class="sh">"""</span>
        <span class="c1"># Simple CNN for object detection
</span>        <span class="n">self</span><span class="p">.</span><span class="n">object_detector</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">MaxPooling2D</span><span class="p">(),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">MaxPooling2D</span><span class="p">(),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Flatten</span><span class="p">(),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">softmax</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 10 object classes
</span>        <span class="p">])</span>
        
        <span class="c1"># Simple LSTM for behavior prediction
</span>        <span class="n">self</span><span class="p">.</span><span class="n">behavior_predictor</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">LSTM</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span>  <span class="c1"># 10 timesteps, 6 features
</span>            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">softmax</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 3 behaviors
</span>        <span class="p">])</span>
        
        <span class="c1"># Simple Q-learning policy
</span>        <span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">q_table</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># 100 states, 4 actions
</span>            <span class="sh">'</span><span class="s">state_discretizer</span><span class="sh">'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">min</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="p">}</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Fallback models initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process incoming camera images.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">bgr8</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_image</span> <span class="o">=</span> <span class="n">cv_image</span>
            
            <span class="c1"># Add to buffer
</span>            <span class="n">self</span><span class="p">.</span><span class="n">image_buffer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
            
            <span class="c1"># Perform object detection
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">detect_objects</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Image processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pointcloud_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process point cloud data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pointcloud</span> <span class="o">=</span> <span class="n">msg</span>
        
        <span class="c1"># Extract features from point cloud
</span>        <span class="n">features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">extract_pointcloud_features</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Add to sensor buffer
</span>        <span class="n">sensor_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="nf">to_sec</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">pointcloud_features</span><span class="sh">'</span><span class="p">:</span> <span class="n">features</span>
        <span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sensor_buffer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pose_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update current pose.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">detect_objects</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Detect objects in the image using ML model.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Preprocess image
</span>            <span class="n">processed_image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            
            <span class="c1"># Run inference
</span>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">object_detector</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">processed_image</span><span class="p">)</span>
            
            <span class="c1"># Process predictions
</span>            <span class="n">detected_objects</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">process_object_predictions</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
            
            <span class="c1"># Publish predictions
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">publish_ml_predictions</span><span class="p">(</span><span class="n">detected_objects</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Object detection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">preprocess_image</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Preprocess image for ML model input.</span><span class="sh">"""</span>
        <span class="c1"># Resize to model input size
</span>        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
        
        <span class="c1"># Normalize
</span>        <span class="n">normalized</span> <span class="o">=</span> <span class="n">resized</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
        
        <span class="c1"># Add batch dimension
</span>        <span class="n">batched</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">expand_dims</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">batched</span>
    
    <span class="k">def</span> <span class="nf">process_object_predictions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process object detection predictions.</span><span class="sh">"""</span>
        <span class="n">detected_objects</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Get class with highest confidence
</span>        <span class="n">class_idx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">class_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">prediction_confidence_threshold</span><span class="p">:</span>
            <span class="n">object_classes</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">obstacle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">target</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wall</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">floor</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ceiling</span><span class="sh">'</span><span class="p">,</span> 
                            <span class="sh">'</span><span class="s">vehicle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">debris</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">structure</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">marker</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="n">detected_objects</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">:</span> <span class="n">object_classes</span><span class="p">[</span><span class="n">class_idx</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">confidence</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">to_sec</span><span class="p">()</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">detected_objects</span>
    
    <span class="k">def</span> <span class="nf">extract_pointcloud_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pointcloud</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Extract features from point cloud data.</span><span class="sh">"""</span>
        <span class="c1"># Simplified feature extraction
</span>        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">point_count</span><span class="sh">'</span><span class="p">:</span> <span class="n">pointcloud</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">pointcloud</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">density</span><span class="sh">'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Placeholder
</span>            <span class="sh">'</span><span class="s">mean_distance</span><span class="sh">'</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># Placeholder
</span>            <span class="sh">'</span><span class="s">variance</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Placeholder
</span>            <span class="sh">'</span><span class="s">obstacle_detected</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span>  <span class="c1"># Placeholder
</span>        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">control_loop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main control loop with ML-based decision making.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">current_image</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">sensor_buffer</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Get current state
</span>        <span class="n">current_state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_current_state</span><span class="p">()</span>
        
        <span class="c1"># Predict behavior using ML
</span>        <span class="n">predicted_behavior</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict_behavior</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
        
        <span class="c1"># Generate action using RL policy
</span>        <span class="n">action</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">select_action</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">predicted_behavior</span><span class="p">)</span>
        
        <span class="c1"># Convert action to control command
</span>        <span class="n">cmd_vel</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">action_to_command</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="c1"># Publish command
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd_vel</span><span class="p">)</span>
        
        <span class="c1"># Store action for learning
</span>        <span class="n">self</span><span class="p">.</span><span class="n">action_history</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">state</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_state</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">to_sec</span><span class="p">()</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_current_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get current state representation for ML models.</span><span class="sh">"""</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">sensor_data</span><span class="sh">'</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sensor_buffer</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:],</span>  <span class="c1"># Last 5 sensor readings
</span>            <span class="sh">'</span><span class="s">image_available</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">pointcloud_available</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pointcloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">state</span>
    
    <span class="k">def</span> <span class="nf">predict_behavior</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Predict optimal behavior using ML model.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Prepare input for behavior predictor
</span>            <span class="n">behavior_input</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prepare_behavior_input</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            
            <span class="c1"># Run prediction
</span>            <span class="n">behavior_probs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">behavior_predictor</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">behavior_input</span><span class="p">)</span>
            
            <span class="c1"># Get predicted behavior
</span>            <span class="n">behavior_classes</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">explore</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">approach</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avoid</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">predicted_class</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">behavior_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">behavior_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">predicted_class</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">behavior</span><span class="sh">'</span><span class="p">:</span> <span class="n">behavior_classes</span><span class="p">[</span><span class="n">predicted_class</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Behavior prediction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">behavior</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">explore</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">prepare_behavior_input</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Prepare input for behavior prediction model.</span><span class="sh">"""</span>
        <span class="c1"># Create feature vector from state
</span>        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Add pose features
</span>        <span class="n">features</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">]])</span>
        
        <span class="c1"># Add sensor features (simplified)
</span>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">sensor_data</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">latest_sensor</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">sensor_data</span><span class="sh">'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">features</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span>
                <span class="n">latest_sensor</span><span class="p">[</span><span class="sh">'</span><span class="s">pointcloud_features</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">point_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span>
                <span class="n">latest_sensor</span><span class="p">[</span><span class="sh">'</span><span class="s">pointcloud_features</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">density</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">latest_sensor</span><span class="p">[</span><span class="sh">'</span><span class="s">pointcloud_features</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">mean_distance</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        
        <span class="c1"># Create sequence for LSTM (repeat current features for simplicity)
</span>        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">features</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Add batch dimension
</span>        <span class="n">batched_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">expand_dims</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">batched_sequence</span>
    
    <span class="k">def</span> <span class="nf">select_action</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">predicted_behavior</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Select action using RL policy.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Discretize state for Q-table lookup
</span>            <span class="n">state_idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">discretize_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            
            <span class="c1"># Epsilon-greedy action selection
</span>            <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">exploration_rate</span><span class="p">:</span>
                <span class="c1"># Random action
</span>                <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Greedy action from Q-table
</span>                <span class="n">q_values</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span><span class="p">[</span><span class="sh">'</span><span class="s">q_table</span><span class="sh">'</span><span class="p">][</span><span class="n">state_idx</span><span class="p">]</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">q_values</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">action</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Action selection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Default action
</span>    
    <span class="k">def</span> <span class="nf">discretize_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Discretize continuous state for Q-table lookup.</span><span class="sh">"""</span>
        <span class="c1"># Simple discretization based on position
</span>        <span class="n">x_discrete</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">int</span><span class="p">((</span><span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">y_discrete</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">int</span><span class="p">((</span><span class="n">state</span><span class="p">[</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
        
        <span class="n">state_idx</span> <span class="o">=</span> <span class="n">x_discrete</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">y_discrete</span>
        <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="n">state_idx</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">action_to_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert discrete action to velocity command.</span><span class="sh">"""</span>
        <span class="n">cmd_vel</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        
        <span class="c1"># Action mapping: 0=forward, 1=backward, 2=left, 3=right
</span>        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Forward
</span>            <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Backward
</span>            <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Left
</span>            <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Right
</span>            <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        
        <span class="k">return</span> <span class="n">cmd_vel</span>
    
    <span class="k">def</span> <span class="nf">update_models</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Periodically update ML models with new data.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">action_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update RL policy with recent experiences
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_rl_policy</span><span class="p">()</span>
            
            <span class="c1"># Optionally retrain other models
</span>            <span class="c1"># self.retrain_behavior_predictor()
</span>            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Model update error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_rl_policy</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update RL policy using recent experiences.</span><span class="sh">"""</span>
        <span class="c1"># Simple Q-learning update
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">action_history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">current_exp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">action_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">next_exp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">action_history</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Calculate reward (simplified)
</span>            <span class="n">reward</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_reward</span><span class="p">(</span><span class="n">current_exp</span><span class="p">,</span> <span class="n">next_exp</span><span class="p">)</span>
            
            <span class="c1"># Q-learning update
</span>            <span class="n">current_state_idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">discretize_state</span><span class="p">(</span><span class="n">current_exp</span><span class="p">[</span><span class="sh">'</span><span class="s">state</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">next_state_idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">discretize_state</span><span class="p">(</span><span class="n">next_exp</span><span class="p">[</span><span class="sh">'</span><span class="s">state</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">current_exp</span><span class="p">[</span><span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="c1"># Q(s,a) = Q(s,a) + α[r + γ*max(Q(s',a')) - Q(s,a)]
</span>            <span class="n">alpha</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">learning_rate</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.9</span>
            
            <span class="n">current_q</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span><span class="p">[</span><span class="sh">'</span><span class="s">q_table</span><span class="sh">'</span><span class="p">][</span><span class="n">current_state_idx</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
            <span class="n">max_next_q</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span><span class="p">[</span><span class="sh">'</span><span class="s">q_table</span><span class="sh">'</span><span class="p">][</span><span class="n">next_state_idx</span><span class="p">])</span>
            
            <span class="n">new_q</span> <span class="o">=</span> <span class="n">current_q</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">reward</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">max_next_q</span> <span class="o">-</span> <span class="n">current_q</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">rl_policy</span><span class="p">[</span><span class="sh">'</span><span class="s">q_table</span><span class="sh">'</span><span class="p">][</span><span class="n">current_state_idx</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_q</span>
    
    <span class="k">def</span> <span class="nf">calculate_reward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_exp</span><span class="p">,</span> <span class="n">next_exp</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate reward for RL update.</span><span class="sh">"""</span>
        <span class="c1"># Simple reward function
</span>        <span class="n">current_pos</span> <span class="o">=</span> <span class="n">current_exp</span><span class="p">[</span><span class="sh">'</span><span class="s">state</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">next_pos</span> <span class="o">=</span> <span class="n">next_exp</span><span class="p">[</span><span class="sh">'</span><span class="s">state</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">pose</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Reward for movement (exploration)
</span>        <span class="n">movement</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">next_pos</span><span class="p">[</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pos</span><span class="p">[</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
            <span class="p">(</span><span class="n">next_pos</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pos</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="p">)</span>
        
        <span class="n">reward</span> <span class="o">=</span> <span class="n">movement</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># Small positive reward for movement
</span>        
        <span class="c1"># Penalty for staying in same place
</span>        <span class="k">if</span> <span class="n">movement</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">-=</span> <span class="mf">0.05</span>
        
        <span class="k">return</span> <span class="n">reward</span>
    
    <span class="k">def</span> <span class="nf">publish_ml_predictions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish ML predictions.</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="n">ml_msg</span> <span class="o">=</span> <span class="nc">MLPrediction</span><span class="p">()</span>
            <span class="n">ml_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
            <span class="n">ml_msg</span><span class="p">.</span><span class="n">object_class</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">ml_msg</span><span class="p">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">prediction_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">ml_msg</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="nc">MLIntegratedController</span><span class="p">()</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h3 id="example-9-real-time-optimization-and-performance-monitoring"> <a href="#example-9-real-time-optimization-and-performance-monitoring" class="anchor-heading" aria-labelledby="example-9-real-time-optimization-and-performance-monitoring"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 9: Real-Time Optimization and Performance Monitoring </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Real-Time Optimization and Performance Monitoring

Demonstrates advanced optimization techniques and comprehensive
performance monitoring for ModCube systems.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">FluidPressure</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">PerformanceMetrics</span><span class="p">,</span> <span class="n">OptimizationStatus</span>
<span class="kn">from</span> <span class="n">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Float64MultiArray</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="n">psutil</span>
<span class="kn">import</span> <span class="n">resource</span>
<span class="kn">from</span> <span class="n">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="n">cvxpy</span> <span class="k">as</span> <span class="n">cp</span>

<span class="k">class</span> <span class="nc">RealTimeOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">realtime_optimizer</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Performance monitoring
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cpu_usage_history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">memory_usage_history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># System state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_velocity</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pressure_data</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Optimization parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># MPC horizon
</span>        <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Time step
</span>        <span class="n">self</span><span class="p">.</span><span class="n">max_optimization_time</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 50ms max
</span>        
        <span class="c1"># Control constraints
</span>        <span class="n">self</span><span class="p">.</span><span class="n">max_thrust</span> <span class="o">=</span> <span class="mf">50.0</span>  <span class="c1"># N
</span>        <span class="n">self</span><span class="p">.</span><span class="n">max_velocity</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># m/s
</span>        <span class="n">self</span><span class="p">.</span><span class="n">max_acceleration</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># m/s²
</span>        
        <span class="c1"># Performance thresholds
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cpu_threshold</span> <span class="o">=</span> <span class="mf">80.0</span>  <span class="c1"># %
</span>        <span class="n">self</span><span class="p">.</span><span class="n">memory_threshold</span> <span class="o">=</span> <span class="mf">85.0</span>  <span class="c1"># %
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_frequency_threshold</span> <span class="o">=</span> <span class="mf">8.0</span>  <span class="c1"># Hz minimum
</span>        
        <span class="c1"># Adaptive parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">adaptive_horizon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dynamic_constraints</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">load_balancing</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/performance_metrics</span><span class="sh">'</span><span class="p">,</span> 
                                         <span class="n">PerformanceMetrics</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimization_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/optimization_status</span><span class="sh">'</span><span class="p">,</span> 
                                              <span class="n">OptimizationStatus</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pose_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pose_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/imu</span><span class="sh">'</span><span class="p">,</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pressure_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pressure</span><span class="sh">'</span><span class="p">,</span> 
                                           <span class="n">FluidPressure</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pressure_callback</span><span class="p">)</span>
        
        <span class="c1"># Target waypoints
</span>        <span class="n">self</span><span class="p">.</span><span class="n">target_waypoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Control and monitoring timers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_loop</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">monitoring_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">monitor_performance</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimization_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">adaptive_optimization</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Real-time optimizer initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pose_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update current pose.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">imu_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update IMU data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">pressure_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update pressure data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pressure_data</span> <span class="o">=</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">control_loop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main control loop with real-time optimization.</span><span class="sh">"""</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current state
</span>            <span class="n">current_state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_current_state</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">current_state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="c1"># Get current target
</span>            <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_current_target</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="c1"># Solve optimization problem
</span>            <span class="n">optimal_control</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">solve_mpc_problem</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            
            <span class="c1"># Apply control
</span>            <span class="k">if</span> <span class="n">optimal_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cmd_vel</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">control_to_twist</span><span class="p">(</span><span class="n">optimal_control</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">cmd_vel</span><span class="p">)</span>
            
            <span class="c1"># Record timing
</span>            <span class="n">loop_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">loop_time</span><span class="p">)</span>
            
            <span class="c1"># Check for target reached
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">check_target_reached</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Control loop error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_current_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get current system state.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">current_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
            <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># vx (would come from velocity estimation)
</span>            <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># vy
</span>            <span class="mf">0.0</span>   <span class="c1"># vz
</span>        <span class="p">])</span>
        
        <span class="k">return</span> <span class="n">state</span>
    
    <span class="k">def</span> <span class="nf">get_current_target</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get current target waypoint.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span> <span class="o">&gt;=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_waypoints</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_waypoints</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">solve_mpc_problem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Solve Model Predictive Control optimization problem.</span><span class="sh">"""</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Adaptive horizon based on system load
</span>            <span class="n">horizon</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_adaptive_horizon</span><span class="p">()</span>
            
            <span class="c1"># State and control dimensions
</span>            <span class="n">n_states</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># [x, y, z, vx, vy, vz]
</span>            <span class="n">n_controls</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># [fx, fy, fz]
</span>            
            <span class="c1"># Decision variables
</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Variable</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Variable</span><span class="p">((</span><span class="n">n_controls</span><span class="p">,</span> <span class="n">horizon</span><span class="p">))</span>
            
            <span class="c1"># System dynamics (simplified)
</span>            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">dt</span>  <span class="c1"># position integration
</span>            
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span> <span class="n">n_controls</span><span class="p">))</span>
            <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">dt</span>  <span class="c1"># acceleration from thrust
</span>            
            <span class="c1"># Cost matrices
</span>            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># State cost
</span>            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># Control cost
</span>            <span class="n">Qf</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Terminal cost
</span>            
            <span class="c1"># Objective function
</span>            <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Initial condition
</span>            <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_state</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
                <span class="c1"># Dynamics constraint
</span>                <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">A</span> <span class="o">@</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span> <span class="o">@</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
                
                <span class="c1"># Stage cost
</span>                <span class="n">target_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_state</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">R</span><span class="p">)</span>
                
                <span class="c1"># Control constraints
</span>                <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_thrust</span><span class="p">)</span>
                
                <span class="c1"># Velocity constraints
</span>                <span class="n">constraints</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_velocity</span><span class="p">)</span>
            
            <span class="c1"># Terminal cost
</span>            <span class="n">target_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="n">cp</span><span class="p">.</span><span class="nf">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">horizon</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_state</span><span class="p">,</span> <span class="n">Qf</span><span class="p">)</span>
            
            <span class="c1"># Solve optimization problem
</span>            <span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nc">Problem</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="nc">Minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
            
            <span class="c1"># Set solver parameters for real-time performance
</span>            <span class="n">problem</span><span class="p">.</span><span class="nf">solve</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="n">cp</span><span class="p">.</span><span class="n">OSQP</span><span class="p">,</span> 
                         <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                         <span class="n">eps_abs</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> 
                         <span class="n">eps_rel</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="n">optimization_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">optimization_time</span><span class="p">)</span>
            
            <span class="c1"># Publish optimization status
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">publish_optimization_status</span><span class="p">(</span><span class="n">problem</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">optimization_time</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">problem</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="p">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">u</span><span class="p">.</span><span class="n">value</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return first control action
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Optimization failed with status: </span><span class="si">{</span><span class="n">problem</span><span class="p">.</span><span class="n">status</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">MPC optimization error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">get_adaptive_horizon</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get adaptive optimization horizon based on system load.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">adaptive_horizon</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span>
        
        <span class="c1"># Get current CPU usage
</span>        <span class="n">current_cpu</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">cpu_percent</span><span class="p">()</span>
        
        <span class="c1"># Reduce horizon if CPU usage is high
</span>        <span class="k">if</span> <span class="n">current_cpu</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">cpu_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_cpu</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span>
    
    <span class="k">def</span> <span class="nf">control_to_twist</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert control forces to Twist message.</span><span class="sh">"""</span>
        <span class="n">cmd_vel</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        
        <span class="c1"># Simple mapping from forces to velocities
</span>        <span class="c1"># In practice, this would involve thruster allocation
</span>        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">cmd_vel</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cmd_vel</span>
    
    <span class="k">def</span> <span class="nf">check_target_reached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check if current target is reached.</span><span class="sh">"""</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">current_state</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>  <span class="c1"># Within 1 meter
</span>            <span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_waypoints</span><span class="p">):</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Target </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s"> reached. Moving to next target.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">All targets reached. Mission complete.</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">monitor_performance</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Monitor system performance metrics.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># CPU and memory usage
</span>            <span class="n">cpu_percent</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">cpu_percent</span><span class="p">()</span>
            <span class="n">memory_info</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">virtual_memory</span><span class="p">()</span>
            <span class="n">memory_percent</span> <span class="o">=</span> <span class="n">memory_info</span><span class="p">.</span><span class="n">percent</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">cpu_usage_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cpu_percent</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">memory_usage_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">memory_percent</span><span class="p">)</span>
            
            <span class="c1"># Control loop frequency
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">recent_times</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
                <span class="n">avg_loop_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">recent_times</span><span class="p">)</span>
                <span class="n">control_frequency</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">avg_loop_time</span> <span class="k">if</span> <span class="n">avg_loop_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_frequency</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Optimization performance
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">recent_opt_times</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">avg_opt_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">recent_opt_times</span><span class="p">)</span>
                <span class="n">max_opt_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">recent_opt_times</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg_opt_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">max_opt_time</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Publish performance metrics
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">publish_performance_metrics</span><span class="p">(</span>
                <span class="n">cpu_percent</span><span class="p">,</span> <span class="n">memory_percent</span><span class="p">,</span> <span class="n">control_frequency</span><span class="p">,</span>
                <span class="n">avg_opt_time</span><span class="p">,</span> <span class="n">max_opt_time</span>
            <span class="p">)</span>
            
            <span class="c1"># Check for performance issues
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">check_performance_issues</span><span class="p">(</span>
                <span class="n">cpu_percent</span><span class="p">,</span> <span class="n">memory_percent</span><span class="p">,</span> <span class="n">control_frequency</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Performance monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">publish_performance_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cpu_percent</span><span class="p">,</span> <span class="n">memory_percent</span><span class="p">,</span> 
                                  <span class="n">control_frequency</span><span class="p">,</span> <span class="n">avg_opt_time</span><span class="p">,</span> <span class="n">max_opt_time</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish performance metrics.</span><span class="sh">"""</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="nc">PerformanceMetrics</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="n">metrics</span><span class="p">.</span><span class="n">cpu_usage</span> <span class="o">=</span> <span class="n">cpu_percent</span>
        <span class="n">metrics</span><span class="p">.</span><span class="n">memory_usage</span> <span class="o">=</span> <span class="n">memory_percent</span>
        <span class="n">metrics</span><span class="p">.</span><span class="n">control_frequency</span> <span class="o">=</span> <span class="n">control_frequency</span>
        <span class="n">metrics</span><span class="p">.</span><span class="n">avg_optimization_time</span> <span class="o">=</span> <span class="n">avg_opt_time</span>
        <span class="n">metrics</span><span class="p">.</span><span class="n">max_optimization_time</span> <span class="o">=</span> <span class="n">max_opt_time</span>
        
        <span class="c1"># Calculate additional metrics
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cpu_usage_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">.</span><span class="n">cpu_usage_trend</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cpu_usage_history</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">.</span><span class="n">control_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)[</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">publish_optimization_status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">optimization_time</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish optimization status.</span><span class="sh">"""</span>
        <span class="n">opt_status</span> <span class="o">=</span> <span class="nc">OptimizationStatus</span><span class="p">()</span>
        <span class="n">opt_status</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">opt_status</span><span class="p">.</span><span class="n">solver_status</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">opt_status</span><span class="p">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="n">optimization_time</span>
        <span class="n">opt_status</span><span class="p">.</span><span class="n">horizon_length</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_adaptive_horizon</span><span class="p">()</span>
        <span class="n">opt_status</span><span class="p">.</span><span class="n">target_index</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_target_idx</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">optimization_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">opt_status</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_performance_issues</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cpu_percent</span><span class="p">,</span> <span class="n">memory_percent</span><span class="p">,</span> <span class="n">control_frequency</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check for performance issues and take corrective actions.</span><span class="sh">"""</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># CPU usage check
</span>        <span class="k">if</span> <span class="n">cpu_percent</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">cpu_threshold</span><span class="p">:</span>
            <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">High CPU usage: </span><span class="si">{</span><span class="n">cpu_percent</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">adaptive_horizon</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">Reducing optimization horizon due to high CPU usage</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Memory usage check
</span>        <span class="k">if</span> <span class="n">memory_percent</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">memory_threshold</span><span class="p">:</span>
            <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">High memory usage: </span><span class="si">{</span><span class="n">memory_percent</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">cleanup_old_data</span><span class="p">()</span>
        
        <span class="c1"># Control frequency check
</span>        <span class="k">if</span> <span class="n">control_frequency</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">control_frequency_threshold</span><span class="p">:</span>
            <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Low control frequency: </span><span class="si">{</span><span class="n">control_frequency</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Hz</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Optimization time check
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recent_opt_time</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recent_opt_time</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_optimization_time</span><span class="p">:</span>
                <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Slow optimization: </span><span class="si">{</span><span class="n">recent_opt_time</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">issues</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Performance issues detected: </span><span class="si">{</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">cleanup_old_data</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Clean up old data to free memory.</span><span class="sh">"""</span>
        <span class="c1"># Reduce buffer sizes temporarily
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="c1"># Keep only recent data
</span>            <span class="n">recent_data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">)[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">control_loop_times</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">recent_data</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaned up old performance data</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">adaptive_optimization</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform adaptive optimization parameter tuning.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Analyze recent performance
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="n">recent_opt_times</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_times</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="n">avg_opt_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">recent_opt_times</span><span class="p">)</span>
            
            <span class="c1"># Adjust parameters based on performance
</span>            <span class="k">if</span> <span class="n">avg_opt_time</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_optimization_time</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="c1"># Optimization is taking too long
</span>                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Reduced optimization horizon to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">avg_opt_time</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_optimization_time</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="c1"># Optimization is fast, can increase horizon
</span>                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Increased optimization horizon to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">optimization_horizon</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Adjust control frequency based on system load
</span>            <span class="n">current_cpu</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">cpu_percent</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_cpu</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">cpu_threshold</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">+=</span> <span class="mf">0.01</span>
                <span class="c1"># Update timer
</span>                <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_loop</span><span class="p">)</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Reduced control frequency to </span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Hz</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">current_cpu</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">dt</span> <span class="o">-=</span> <span class="mf">0.01</span>
                <span class="c1"># Update timer
</span>                <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_loop</span><span class="p">)</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Increased control frequency to </span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Hz</span><span class="sh">"</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Adaptive optimization error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PerformanceBenchmark</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Performance benchmarking utilities.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">benchmark_results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">benchmark_control_loop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Benchmark control loop performance.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Starting control loop benchmark (</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s"> iterations)</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="c1"># Simulate control loop
</span>            <span class="n">current_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
            
            <span class="n">optimal_control</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">solve_mpc_problem</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">times</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Benchmark progress: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Calculate statistics
</span>        <span class="n">avg_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">std_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">min_time</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">benchmark_results</span><span class="p">[</span><span class="sh">'</span><span class="s">control_loop</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">avg_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">std_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">std_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">max_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">max_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">min_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">frequency</span><span class="sh">'</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">avg_time</span>
        <span class="p">}</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Control loop benchmark results:</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Average time: </span><span class="si">{</span><span class="n">avg_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Std deviation: </span><span class="si">{</span><span class="n">std_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Max time: </span><span class="si">{</span><span class="n">max_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Min time: </span><span class="si">{</span><span class="n">min_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Average frequency: </span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="n">avg_time</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Hz</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">benchmark_memory_usage</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Benchmark memory usage over time.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Starting memory benchmark (</span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s">s)</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">memory_samples</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">while</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">:</span>
            <span class="n">memory_info</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">virtual_memory</span><span class="p">()</span>
            <span class="n">memory_samples</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">memory_info</span><span class="p">.</span><span class="n">percent</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Calculate statistics
</span>        <span class="n">avg_memory</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">memory_samples</span><span class="p">)</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">memory_samples</span><span class="p">)</span>
        <span class="n">min_memory</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">memory_samples</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">benchmark_results</span><span class="p">[</span><span class="sh">'</span><span class="s">memory</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">avg_usage</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_memory</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">max_usage</span><span class="sh">'</span><span class="p">:</span> <span class="n">max_memory</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min_usage</span><span class="sh">'</span><span class="p">:</span> <span class="n">min_memory</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">samples</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">memory_samples</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Memory benchmark results:</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Average usage: </span><span class="si">{</span><span class="n">avg_memory</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Max usage: </span><span class="si">{</span><span class="n">max_memory</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Min usage: </span><span class="si">{</span><span class="n">min_memory</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">RealTimeOptimizer</span><span class="p">()</span>
        
        <span class="c1"># Optional: Run benchmarks
</span>        <span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">get_param</span><span class="p">(</span><span class="sh">'</span><span class="s">~run_benchmark</span><span class="sh">'</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">benchmark</span> <span class="o">=</span> <span class="nc">PerformanceBenchmark</span><span class="p">()</span>
            <span class="n">benchmark</span><span class="p">.</span><span class="nf">benchmark_control_loop</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">benchmark</span><span class="p">.</span><span class="nf">benchmark_memory_usage</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
        
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="advanced-integration-examples"> <a href="#advanced-integration-examples" class="anchor-heading" aria-labelledby="advanced-integration-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Integration Examples </h2> <h3 id="example-10-complete-mission-integration"> <a href="#example-10-complete-mission-integration" class="anchor-heading" aria-labelledby="example-10-complete-mission-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 10: Complete Mission Integration </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Complete Mission Integration Example

Demonstrates integration of all advanced features:
- Multi-robot coordination
- Machine learning
- Real-time optimization
- Performance monitoring
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">from</span> <span class="n">multi_robot_coordinator</span> <span class="kn">import</span> <span class="n">MultiRobotCoordinator</span>
<span class="kn">from</span> <span class="n">ml_integrated_controller</span> <span class="kn">import</span> <span class="n">MLIntegratedController</span>
<span class="kn">from</span> <span class="n">realtime_optimizer</span> <span class="kn">import</span> <span class="n">RealTimeOptimizer</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">class</span> <span class="nc">IntegratedMissionController</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">=</span> <span class="n">vehicle_id</span>
        
        <span class="c1"># Initialize subsystems
</span>        <span class="n">self</span><span class="p">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="nc">MultiRobotCoordinator</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ml_controller</span> <span class="o">=</span> <span class="nc">MLIntegratedController</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="nc">RealTimeOptimizer</span><span class="p">()</span>
        
        <span class="c1"># Mission state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">mission_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mission_phase</span> <span class="o">=</span> <span class="sh">'</span><span class="s">idle</span><span class="sh">'</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Integrated mission controller initialized for vehicle </span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute_integrated_mission</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute complete integrated mission.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting integrated mission</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Phase 1: Formation and coordination
</span>            <span class="n">self</span><span class="p">.</span><span class="n">mission_phase</span> <span class="o">=</span> <span class="sh">'</span><span class="s">formation</span><span class="sh">'</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">execute_formation_phase</span><span class="p">()</span>
            
            <span class="c1"># Phase 2: ML-guided exploration
</span>            <span class="n">self</span><span class="p">.</span><span class="n">mission_phase</span> <span class="o">=</span> <span class="sh">'</span><span class="s">exploration</span><span class="sh">'</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">execute_exploration_phase</span><span class="p">()</span>
            
            <span class="c1"># Phase 3: Optimized task execution
</span>            <span class="n">self</span><span class="p">.</span><span class="n">mission_phase</span> <span class="o">=</span> <span class="sh">'</span><span class="s">execution</span><span class="sh">'</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">execute_task_phase</span><span class="p">()</span>
            
            <span class="c1"># Phase 4: Return and debrief
</span>            <span class="n">self</span><span class="p">.</span><span class="n">mission_phase</span> <span class="o">=</span> <span class="sh">'</span><span class="s">return</span><span class="sh">'</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">execute_return_phase</span><span class="p">()</span>
            
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Integrated mission completed successfully</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Integrated mission failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute_formation_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute formation and coordination phase.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing formation phase</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Formation logic handled by coordinator
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Simulate formation time
</span>    
    <span class="k">def</span> <span class="nf">execute_exploration_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute ML-guided exploration phase.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing exploration phase</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># ML exploration logic
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Simulate exploration time
</span>    
    <span class="k">def</span> <span class="nf">execute_task_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute optimized task execution phase.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing task phase</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Optimized task execution
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Simulate task time
</span>    
    <span class="k">def</span> <span class="nf">execute_return_phase</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute return phase.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing return phase</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Return to base
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Simulate return time
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sh">"</span><span class="s">Usage: integrated_mission.py &lt;vehicle_id&gt;</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">vehicle_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="nc">IntegratedMissionController</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">)</span>
        
        <span class="c1"># Start mission in separate thread
</span>        <span class="n">mission_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">controller</span><span class="p">.</span><span class="n">execute_integrated_mission</span><span class="p">)</span>
        <span class="n">mission_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
        
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h2> <p>These advanced examples demonstrate the full capabilities of the RS-ModCubes system:</p> <ol> <li><strong>Search and Rescue Mission</strong>: Complete autonomous mission with multiple phases</li> <li><strong>Autonomous Inspection</strong>: Detailed structural inspection with computer vision</li> <li><strong>Multi-Robot Coordination</strong>: Fleet operations with formation control</li> <li><strong>Machine Learning Integration</strong>: Adaptive behavior with neural networks</li> <li><strong>Real-Time Optimization</strong>: MPC with performance monitoring</li> <li><strong>Integrated Mission</strong>: Complete system integration</li> </ol> <p>Each example showcases different aspects of advanced autonomous underwater vehicle operations, from basic control to sophisticated AI-driven decision making and multi-vehicle coordination.</p> <h3 id="key-features-demonstrated"> <a href="#key-features-demonstrated" class="anchor-heading" aria-labelledby="key-features-demonstrated"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key Features Demonstrated: </h3> <ul> <li><strong>Modular Architecture</strong>: Each component can be used independently</li> <li><strong>Real-Time Performance</strong>: Optimized for real-time operation</li> <li><strong>Scalability</strong>: Supports single and multi-vehicle operations</li> <li><strong>Adaptability</strong>: Machine learning and adaptive algorithms</li> <li><strong>Robustness</strong>: Error handling and performance monitoring</li> <li><strong>Integration</strong>: Seamless integration of multiple subsystems</li> </ul> <p>These examples provide a comprehensive foundation for developing advanced autonomous underwater vehicle applications using the RS-ModCubes platform. area=self.search_area, pattern=self.search_pattern, spacing=self.search_spacing )</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    rospy.loginfo(f"Generated {len(search_waypoints)} search waypoints")
    
    # Execute search pattern
    for i, waypoint in enumerate(search_waypoints):
        if rospy.is_shutdown() or self.is_aborted():
            return False
        
        rospy.loginfo(f"Moving to search waypoint {i+1}/{len(search_waypoints)}")
        
        success = self.motion_client.goto_position(
            waypoint.x, waypoint.y, waypoint.z,
            timeout=30.0
        )
        
        if not success:
            rospy.logwarn(f"Failed to reach waypoint {i+1}")
            continue
        
        # Pause for detection
        rospy.sleep(2.0)
        
        # Update progress
        progress = (i + 1) / len(search_waypoints) * 100
        self.update_progress(progress)
    
    rospy.loginfo("Search phase completed")
    return True

def execute_investigation_phase(self):
    """Investigate detected targets more closely."""
    rospy.loginfo(f"Starting investigation of {len(self.targets_found)} targets")
    
    for i, target in enumerate(self.targets_found):
        if rospy.is_shutdown() or self.is_aborted():
            return False
        
        rospy.loginfo(f"Investigating target {target['id']}")
        
        # Move closer to target for detailed inspection
        investigation_pos = Point(
            x=target['position'].x,
            y=target['position'].y,
            z=target['position'].z + 1.0  # 1m above target
        )
        
        success = self.motion_client.goto_position(
            investigation_pos.x, investigation_pos.y, investigation_pos.z,
            timeout=20.0
        )
        
        if success:
            # Perform detailed inspection
            self.perform_detailed_inspection(target)
        else:
            rospy.logwarn(f"Failed to reach investigation position for target {target['id']}")
        
        # Update progress
        progress = (i + 1) / len(self.targets_found) * 100
        self.update_progress(progress)
    
    rospy.loginfo("Investigation phase completed")
    return True

def perform_detailed_inspection(self, target):
    """Perform detailed inspection of a target."""
    rospy.loginfo(f"Performing detailed inspection of target {target['id']}")
    
    # Circle around target for multiple viewing angles
    circle_radius = 2.0
    num_positions = 8
    
    for i in range(num_positions):
        angle = 2 * np.pi * i / num_positions
        
        inspect_pos = Point(
            x=target['position'].x + circle_radius * np.cos(angle),
            y=target['position'].y + circle_radius * np.sin(angle),
            z=target['position'].z + 1.0
        )
        
        self.motion_client.goto_position(
            inspect_pos.x, inspect_pos.y, inspect_pos.z,
            timeout=15.0
        )
        
        # Pause for data collection
        rospy.sleep(1.0)
    
    # Update target information
    target['inspected'] = True
    target['inspection_time'] = rospy.Time.now()

def execute_recovery_phase(self):
    """Execute recovery operations for confirmed targets."""
    rospy.loginfo("Starting recovery phase")
    
    # Sort targets by priority (e.g., confidence, detection time)
    sorted_targets = sorted(self.targets_found, 
                          key=lambda t: t['confidence'], reverse=True)
    
    for i, target in enumerate(sorted_targets):
        if rospy.is_shutdown() or self.is_aborted():
            return False
        
        rospy.loginfo(f"Recovering target {target['id']}")
        
        # Move to recovery position
        recovery_pos = Point(
            x=target['position'].x,
            y=target['position'].y,
            z=target['position'].z + 0.5  # 0.5m above target
        )
        
        success = self.motion_client.goto_position(
            recovery_pos.x, recovery_pos.y, recovery_pos.z,
            timeout=20.0
        )
        
        if success:
            # Simulate recovery operation
            self.perform_recovery_operation(target)
        else:
            rospy.logwarn(f"Failed to reach recovery position for target {target['id']}")
        
        # Update progress
        progress = (i + 1) / len(sorted_targets) * 100
        self.update_progress(progress)
    
    rospy.loginfo("Recovery phase completed")
    return True

def perform_recovery_operation(self, target):
    """Perform recovery operation for a target."""
    rospy.loginfo(f"Performing recovery operation for target {target['id']}")
    
    # Simulate manipulator operations
    # In practice, this would involve:
    # - Precise positioning
    # - Manipulator control
    # - Grasping operations
    # - Secure storage
    
    rospy.sleep(5.0)  # Simulate recovery time
    
    target['recovered'] = True
    target['recovery_time'] = rospy.Time.now()
    
    rospy.loginfo(f"Target {target['id']} successfully recovered")
</code></pre></div></div> <p>if <strong>name</strong> == ‘<strong>main</strong>’: try: rospy.init_node(‘search_rescue_mission’)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    mission = SearchRescueMission()
    success = mission.execute()
    
    if success:
        rospy.loginfo("Search and Rescue mission completed successfully")
    else:
        rospy.logwarn("Search and Rescue mission failed")
        
except rospy.ROSInterruptException:
    pass ```
</code></pre></div></div> <h3 id="example-6-inspection-mission"> <a href="#example-6-inspection-mission" class="anchor-heading" aria-labelledby="example-6-inspection-mission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 6: Inspection Mission </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Infrastructure Inspection Mission

Performs detailed inspection of underwater infrastructure
using multiple sensors and systematic coverage patterns.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">PointCloud2</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">InspectionData</span>
<span class="kn">from</span> <span class="n">modcube_mission</span> <span class="kn">import</span> <span class="n">BaseMission</span>
<span class="kn">from</span> <span class="n">modcube_common.motion</span> <span class="kn">import</span> <span class="n">MotionClient</span>
<span class="kn">from</span> <span class="n">modcube_common.vision</span> <span class="kn">import</span> <span class="n">InspectionAnalyzer</span>

<span class="k">class</span> <span class="nc">InspectionMission</span><span class="p">(</span><span class="n">BaseMission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">structure_model</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span> <span class="o">=</span> <span class="nc">MotionClient</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inspection_analyzer</span> <span class="o">=</span> <span class="nc">InspectionAnalyzer</span><span class="p">()</span>
        
        <span class="c1"># Structure to inspect
</span>        <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span> <span class="o">=</span> <span class="n">structure_model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Inspection parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># meters from structure
</span>        <span class="n">self</span><span class="p">.</span><span class="n">overlap_percentage</span> <span class="o">=</span> <span class="mi">30</span>    <span class="c1"># percent overlap between views
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_speed</span> <span class="o">=</span> <span class="mf">0.2</span>     <span class="c1"># m/s
</span>        
        <span class="c1"># Data collection
</span>        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span>
                                        <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cloud_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pointcloud</span><span class="sh">'</span><span class="p">,</span>
                                        <span class="n">PointCloud2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cloud_callback</span><span class="p">)</span>
        
        <span class="c1"># Data storage
</span>        <span class="n">self</span><span class="p">.</span><span class="n">inspection_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/inspection_data</span><span class="sh">'</span><span class="p">,</span>
                                            <span class="n">InspectionData</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process camera images for inspection.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="sh">'</span><span class="s">inspecting</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Analyze image for defects, corrosion, etc.
</span>            <span class="n">analysis_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_analyzer</span><span class="p">.</span><span class="nf">analyze_image</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">analysis_result</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">store_inspection_data</span><span class="p">(</span><span class="sh">'</span><span class="s">visual</span><span class="sh">'</span><span class="p">,</span> <span class="n">analysis_result</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">cloud_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process point cloud data for 3D inspection.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="sh">'</span><span class="s">inspecting</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Analyze point cloud for structural deformation
</span>            <span class="n">analysis_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_analyzer</span><span class="p">.</span><span class="nf">analyze_pointcloud</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">analysis_result</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">store_inspection_data</span><span class="p">(</span><span class="sh">'</span><span class="s">geometric</span><span class="sh">'</span><span class="p">,</span> <span class="n">analysis_result</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">store_inspection_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">analysis_result</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Store inspection data with metadata.</span><span class="sh">"""</span>
        <span class="n">inspection_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">get_current_pose</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">data_type</span><span class="sh">'</span><span class="p">:</span> <span class="n">data_type</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">analysis</span><span class="sh">'</span><span class="p">:</span> <span class="n">analysis_result</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">inspection_data</span><span class="p">)</span>
        
        <span class="c1"># Publish for real-time monitoring
</span>        <span class="n">msg</span> <span class="o">=</span> <span class="nc">InspectionData</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">inspection_data</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">data_type</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">inspection_data</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># ... fill additional fields
</span>        
        <span class="n">self</span><span class="p">.</span><span class="n">inspection_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute the inspection mission.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting infrastructure inspection mission</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Phase 1: Generate inspection plan
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">planning</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">planning_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_inspection_plan</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">planning_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 2: Execute inspection
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">inspecting</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">inspection_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_inspection</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inspection_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Phase 3: Data analysis and reporting
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">analyzing</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">analysis_success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">analyze_inspection_data</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_success</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="c1"># Mission completed
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">completed</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission completed successfully</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Inspection mission failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">generate_inspection_plan</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate systematic inspection plan for the structure.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Generating inspection plan</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># For a cylindrical structure (e.g., pipeline, pillar)
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">cylinder</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_cylinder_inspection_points</span><span class="p">()</span>
        
        <span class="c1"># For a planar structure (e.g., wall, panel)
</span>        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">plane</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_plane_inspection_points</span><span class="p">()</span>
        
        <span class="c1"># For a complex structure
</span>        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">complex</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_complex_inspection_points</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown structure type: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Generated </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">)</span><span class="si">}</span><span class="s"> inspection points</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">generate_cylinder_inspection_points</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate inspection points for cylindrical structure.</span><span class="sh">"""</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">center</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">radius</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Calculate inspection parameters
</span>        <span class="n">inspection_radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span>
        
        <span class="c1"># Vertical spacing based on camera field of view
</span>        <span class="n">vertical_spacing</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># meters
</span>        <span class="n">num_levels</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">vertical_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Angular spacing for complete coverage
</span>        <span class="n">angular_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>  <span class="c1"># 30 degrees
</span>        <span class="n">num_angles</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">angular_spacing</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">level</span> <span class="o">*</span> <span class="n">vertical_spacing</span>
            
            <span class="k">for</span> <span class="n">angle_idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_angles</span><span class="p">):</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_idx</span> <span class="o">*</span> <span class="n">angular_spacing</span>
                
                <span class="n">x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">inspection_radius</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">inspection_radius</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                
                <span class="c1"># Calculate orientation to face the structure
</span>                <span class="n">yaw</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span>  <span class="c1"># Face inward
</span>                
                <span class="n">point</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
                    <span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">yaw</span><span class="p">),</span>
                    <span class="sh">'</span><span class="s">level</span><span class="sh">'</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">angle</span><span class="sh">'</span><span class="p">:</span> <span class="n">angle</span>
                <span class="p">}</span>
                
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">points</span>
    
    <span class="k">def</span> <span class="nf">generate_plane_inspection_points</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate inspection points for planar structure.</span><span class="sh">"""</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Structure parameters
</span>        <span class="n">corner1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">corner1</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">corner2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">corner2</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">normal</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Calculate inspection grid
</span>        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">corner2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">corner1</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">structure_model</span><span class="p">[</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="n">grid_spacing</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># meters
</span>        <span class="n">num_x</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">grid_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_z</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">grid_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_z</span><span class="p">):</span>
                <span class="c1"># Calculate position on the structure surface
</span>                <span class="n">u</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_x</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_z</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                
                <span class="n">surface_point</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">corner1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">corner2</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span>
                    <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span> <span class="o">*</span> <span class="n">height</span><span class="p">])</span>
                <span class="p">)</span>
                
                <span class="c1"># Offset by inspection distance along normal
</span>                <span class="n">inspection_point</span> <span class="o">=</span> <span class="n">surface_point</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_distance</span>
                
                <span class="c1"># Calculate orientation to face the structure
</span>                <span class="n">orientation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normal_to_quaternion</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
                
                <span class="n">point</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="nc">Point</span><span class="p">(</span><span class="n">inspection_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inspection_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inspection_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">grid_x</span><span class="sh">'</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">grid_z</span><span class="sh">'</span><span class="p">:</span> <span class="n">j</span>
                <span class="p">}</span>
                
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">points</span>
    
    <span class="k">def</span> <span class="nf">execute_inspection</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute the inspection by visiting all planned points.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting inspection execution</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="nf">is_shutdown</span><span class="p">()</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_aborted</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
            
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Moving to inspection point </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Create pose from point
</span>            <span class="n">pose</span> <span class="o">=</span> <span class="nc">Pose</span><span class="p">()</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="c1"># Move to inspection point
</span>            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to reach inspection point </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Perform inspection at this point
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">perform_point_inspection</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            
            <span class="c1"># Update progress
</span>            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection execution completed</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">perform_point_inspection</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform detailed inspection at a specific point.</span><span class="sh">"""</span>
        <span class="c1"># Stabilize at position
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Collect data for specified duration
</span>        <span class="n">inspection_duration</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># seconds
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="nf">while </span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">).</span><span class="nf">to_sec</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">inspection_duration</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Completed inspection at point </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">analyze_inspection_data</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Analyze collected inspection data and generate report.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Analyzing inspection data</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Categorize findings
</span>        <span class="n">defects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">:</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">analysis</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="sh">'</span><span class="s">defects</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">:</span>
                <span class="n">defects</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">defects</span><span class="sh">'</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="sh">'</span><span class="s">anomalies</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">:</span>
                <span class="n">anomalies</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">anomalies</span><span class="sh">'</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="sh">'</span><span class="s">measurements</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">measurements</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># Generate summary report
</span>        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">total_points_inspected</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">total_data_collected</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">defects_found</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">defects</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">anomalies_detected</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">measurements_taken</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">inspection_coverage</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">calculate_coverage</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_recommendations</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span> <span class="n">anomalies</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Save report
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">save_inspection_report</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Analysis completed. Found </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">defects</span><span class="p">)</span><span class="si">}</span><span class="s"> defects and </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span><span class="si">}</span><span class="s"> anomalies</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">calculate_coverage</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate inspection coverage percentage.</span><span class="sh">"""</span>
        <span class="c1"># Simplified coverage calculation
</span>        <span class="c1"># In practice, this would be more sophisticated
</span>        <span class="n">planned_points</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inspection_points</span><span class="p">)</span>
        <span class="n">completed_points</span> <span class="o">=</span> <span class="nf">len</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">inspection_data</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">data_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">visual</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="nf">return </span><span class="p">(</span><span class="n">completed_points</span> <span class="o">/</span> <span class="n">planned_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">planned_points</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">generate_recommendations</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">defects</span><span class="p">,</span> <span class="n">anomalies</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate maintenance recommendations based on findings.</span><span class="sh">"""</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">defects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">High number of defects detected. Immediate maintenance recommended.</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Structural anomalies detected. Further investigation required.</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">defects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Structure appears to be in good condition. Continue regular monitoring.</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">save_inspection_report</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Save inspection report to file.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="kn">import</span> <span class="n">os</span>
        
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">to_sec</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">inspection_report_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">/tmp</span><span class="sh">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Inspection report saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">yaw_to_quaternion</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert yaw angle to quaternion.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">math</span>
        <span class="k">return</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">w</span><span class="o">=</span><span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">normal_to_quaternion</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert normal vector to quaternion orientation.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">math</span>
        
        <span class="c1"># Calculate yaw and pitch from normal vector
</span>        <span class="n">yaw</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">normal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">normal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">asin</span><span class="p">(</span><span class="o">-</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Convert to quaternion
</span>        <span class="n">cy</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">pitch</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">pitch</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sp</span> <span class="o">*</span> <span class="n">cy</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cp</span><span class="p">,</span>
            <span class="n">w</span><span class="o">=</span><span class="n">cp</span> <span class="o">*</span> <span class="n">cy</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">inspection_mission</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Define structure to inspect
</span>        <span class="n">structure_model</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">cylinder</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">radius</span><span class="sh">'</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">:</span> <span class="mf">10.0</span>
        <span class="p">}</span>
        
        <span class="n">mission</span> <span class="o">=</span> <span class="nc">InspectionMission</span><span class="p">(</span><span class="n">structure_model</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">mission</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission completed successfully</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">Inspection mission failed</span><span class="sh">"</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="sensor-integration"> <a href="#sensor-integration" class="anchor-heading" aria-labelledby="sensor-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sensor Integration </h2> <h3 id="example-7-multi-sensor-fusion"> <a href="#example-7-multi-sensor-fusion" class="anchor-heading" aria-labelledby="example-7-multi-sensor-fusion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 7: Multi-Sensor Fusion </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Multi-Sensor Fusion Example

Demonstrates integration and fusion of multiple sensor modalities
for robust state estimation and environmental perception.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">PointCloud2</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">PoseWithCovariance</span><span class="p">,</span> <span class="n">TwistWithCovariance</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">FluidDepth</span><span class="p">,</span> <span class="n">NavState</span>
<span class="kn">from</span> <span class="n">modcube_common.filters</span> <span class="kn">import</span> <span class="n">ExtendedKalmanFilter</span>
<span class="kn">from</span> <span class="n">modcube_common.vision</span> <span class="kn">import</span> <span class="n">VisualOdometry</span>

<span class="k">class</span> <span class="nc">MultiSensorFusion</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">multi_sensor_fusion</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Initialize filters and processors
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span> <span class="o">=</span> <span class="nc">ExtendedKalmanFilter</span><span class="p">(</span><span class="n">state_dim</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># [pos, vel, acc, orient, ang_vel]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">visual_odometry</span> <span class="o">=</span> <span class="nc">VisualOdometry</span><span class="p">()</span>
        
        <span class="c1"># Sensor data buffers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Sensor subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">imu_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/imu/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">Imu</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/dvl/data</span><span class="sh">'</span><span class="p">,</span> <span class="n">DVLData</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/depth</span><span class="sh">'</span><span class="p">,</span> <span class="n">FluidDepth</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/camera/image_raw</span><span class="sh">'</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cloud_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/pointcloud</span><span class="sh">'</span><span class="p">,</span> <span class="n">PointCloud2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cloud_callback</span><span class="p">)</span>
        
        <span class="c1"># State publisher
</span>        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Fusion timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">fusion_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.02</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">fusion_callback</span><span class="p">)</span>  <span class="c1"># 50 Hz
</span>        
        <span class="c1"># Sensor health monitoring
</span>        <span class="n">self</span><span class="p">.</span><span class="n">sensor_health</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">imu</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">last_update</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">dvl</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">last_update</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">last_update</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">visual</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">last_update</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Multi-sensor fusion initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">imu_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process IMU data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">orientation</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">angular_velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">linear_acceleration</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">orientation_covariance</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">orientation_covariance</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">angular_velocity_covariance</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">angular_velocity_covariance</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">linear_acceleration_covariance</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">linear_acceleration_covariance</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">update_sensor_health</span><span class="p">(</span><span class="sh">'</span><span class="s">imu</span><span class="sh">'</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dvl_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process DVL data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">altitude</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">altitude</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">beam_ranges</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">beam_ranges</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">beam_velocities</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">beam_velocities</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">status</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">update_sensor_health</span><span class="p">(</span><span class="sh">'</span><span class="s">dvl</span><span class="sh">'</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">depth_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process depth sensor data.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">pressure</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">pressure</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">temperature</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">temperature</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="nf">update_sensor_health</span><span class="p">(</span><span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process camera images for visual odometry.</span><span class="sh">"""</span>
        <span class="c1"># Process visual odometry
</span>        <span class="n">vo_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">visual_odometry</span><span class="p">.</span><span class="nf">process_image</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">vo_result</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">pose_delta</span><span class="sh">'</span><span class="p">:</span> <span class="n">vo_result</span><span class="p">[</span><span class="sh">'</span><span class="s">pose_delta</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="n">vo_result</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">:</span> <span class="n">vo_result</span><span class="p">[</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="n">self</span><span class="p">.</span><span class="nf">update_sensor_health</span><span class="p">(</span><span class="sh">'</span><span class="s">visual</span><span class="sh">'</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">cloud_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process point cloud data for obstacle detection and mapping.</span><span class="sh">"""</span>
        <span class="c1"># Process point cloud for environmental awareness
</span>        <span class="c1"># This could include obstacle detection, SLAM, etc.
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_sensor_health</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sensor_name</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update sensor health status.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sensor_health</span><span class="p">[</span><span class="n">sensor_name</span><span class="p">][</span><span class="sh">'</span><span class="s">last_update</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
        
        <span class="c1"># Check if sensor is healthy (received data recently)
</span>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">).</span><span class="nf">to_sec</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>  <span class="c1"># Less than 1 second old
</span>            <span class="n">self</span><span class="p">.</span><span class="n">sensor_health</span><span class="p">[</span><span class="n">sensor_name</span><span class="p">][</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">healthy</span><span class="sh">'</span>
        <span class="k">elif</span> <span class="n">time_diff</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>  <span class="c1"># Less than 5 seconds old
</span>            <span class="n">self</span><span class="p">.</span><span class="n">sensor_health</span><span class="p">[</span><span class="n">sensor_name</span><span class="p">][</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">degraded</span><span class="sh">'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sensor_health</span><span class="p">[</span><span class="n">sensor_name</span><span class="p">][</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">failed</span><span class="sh">'</span>
    
    <span class="k">def</span> <span class="nf">fusion_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main sensor fusion loop.</span><span class="sh">"""</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="c1"># Prediction step
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        
        <span class="c1"># Update with available sensor data
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_data_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_with_imu</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_data_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_with_dvl</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_data</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_data_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">depth_data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_with_depth</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_data_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">visual_data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_with_visual</span><span class="p">()</span>
        
        <span class="c1"># Publish fused navigation state
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">publish_nav_state</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">is_data_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">max_age</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check if sensor data is fresh enough to use.</span><span class="sh">"""</span>
        <span class="n">age</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">]).</span><span class="nf">to_sec</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="n">max_age</span>
    
    <span class="k">def</span> <span class="nf">update_with_imu</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update EKF with IMU measurements.</span><span class="sh">"""</span>
        <span class="c1"># Extract measurements
</span>        <span class="n">orientation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">angular_velocity</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">angular_velocity</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">linear_acceleration</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">linear_acceleration</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Convert quaternion to euler angles
</span>        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">quaternion_to_euler</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
        
        <span class="c1"># Measurement vector: [roll, pitch, yaw, wx, wy, wz, ax, ay, az]
</span>        <span class="n">z_imu</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
            <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span>
            <span class="n">angular_velocity</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">angular_velocity</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">angular_velocity</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
            <span class="n">linear_acceleration</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">linear_acceleration</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">linear_acceleration</span><span class="p">.</span><span class="n">z</span>
        <span class="p">])</span>
        
        <span class="c1"># Measurement covariance
</span>        <span class="n">R_imu</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">block</span><span class="p">([</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">orientation_covariance</span><span class="sh">'</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">))],</span>
            <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">angular_velocity_covariance</span><span class="sh">'</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))],</span>
            <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span> <span class="n">self</span><span class="p">.</span><span class="n">imu_data</span><span class="p">[</span><span class="sh">'</span><span class="s">linear_acceleration_covariance</span><span class="sh">'</span><span class="p">]]</span>
        <span class="p">])</span>
        
        <span class="c1"># Update EKF
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">z_imu</span><span class="p">,</span> <span class="n">R_imu</span><span class="p">,</span> <span class="n">measurement_model</span><span class="o">=</span><span class="sh">'</span><span class="s">imu</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_with_dvl</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update EKF with DVL measurements.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check DVL status
</span>            <span class="k">return</span>
        
        <span class="c1"># Extract velocity measurements
</span>        <span class="n">velocity</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dvl_data</span><span class="p">[</span><span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Measurement vector: [vx, vy, vz]
</span>        <span class="n">z_dvl</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">velocity</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">velocity</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">velocity</span><span class="p">.</span><span class="n">z</span><span class="p">])</span>
        
        <span class="c1"># Measurement covariance (simplified)
</span>        <span class="n">R_dvl</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>  <span class="c1"># 1 cm/s standard deviation
</span>        
        <span class="c1"># Update EKF
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">z_dvl</span><span class="p">,</span> <span class="n">R_dvl</span><span class="p">,</span> <span class="n">measurement_model</span><span class="o">=</span><span class="sh">'</span><span class="s">dvl</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_with_depth</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update EKF with depth measurements.</span><span class="sh">"""</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_data</span><span class="p">[</span><span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Measurement vector: [z]
</span>        <span class="n">z_depth</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">depth</span><span class="p">])</span>
        
        <span class="c1"># Measurement covariance
</span>        <span class="n">R_depth</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">]])</span>  <span class="c1"># 1 cm standard deviation
</span>        
        <span class="c1"># Update EKF
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">z_depth</span><span class="p">,</span> <span class="n">R_depth</span><span class="p">,</span> <span class="n">measurement_model</span><span class="o">=</span><span class="sh">'</span><span class="s">depth</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_with_visual</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update EKF with visual odometry measurements.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Low confidence
</span>            <span class="k">return</span>
        
        <span class="n">pose_delta</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span><span class="p">[</span><span class="sh">'</span><span class="s">pose_delta</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Extract position and orientation changes
</span>        <span class="n">dx</span> <span class="o">=</span> <span class="n">pose_delta</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pose_delta</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">pose_delta</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">dyaw</span> <span class="o">=</span> <span class="n">pose_delta</span><span class="p">[</span><span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">yaw</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Measurement vector: [dx, dy, dz, dyaw]
</span>        <span class="n">z_visual</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">dyaw</span><span class="p">])</span>
        
        <span class="c1"># Measurement covariance (based on confidence)
</span>        <span class="n">confidence</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">visual_data</span><span class="p">[</span><span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">base_variance</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">/</span> <span class="n">confidence</span>  <span class="c1"># Higher variance for lower confidence
</span>        <span class="n">R_visual</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diag</span><span class="p">([</span><span class="n">base_variance</span><span class="p">,</span> <span class="n">base_variance</span><span class="p">,</span> <span class="n">base_variance</span><span class="p">,</span> <span class="n">base_variance</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">])</span>
        
        <span class="c1"># Update EKF
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">z_visual</span><span class="p">,</span> <span class="n">R_visual</span><span class="p">,</span> <span class="n">measurement_model</span><span class="o">=</span><span class="sh">'</span><span class="s">visual</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">publish_nav_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Publish the fused navigation state.</span><span class="sh">"""</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">get_state</span><span class="p">()</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ekf</span><span class="p">.</span><span class="nf">get_covariance</span><span class="p">()</span>
        
        <span class="n">nav_msg</span> <span class="o">=</span> <span class="nc">NavState</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">odom</span><span class="sh">'</span>
        
        <span class="c1"># Position
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Orientation (convert from euler to quaternion)
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">euler_to_quaternion</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
        
        <span class="c1"># Velocity
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        
        <span class="c1"># Angular velocity
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
        
        <span class="c1"># Covariances (simplified)
</span>        <span class="n">nav_msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">6</span><span class="p">].</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="n">nav_msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">9</span><span class="p">].</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">30</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">nav_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">nav_msg</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">quaternion_to_euler</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert quaternion to euler angles.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">math</span>
        
        <span class="c1"># Roll (x-axis rotation)
</span>        <span class="n">sinr_cosp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">cosr_cosp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">sinr_cosp</span><span class="p">,</span> <span class="n">cosr_cosp</span><span class="p">)</span>
        
        <span class="c1"># Pitch (y-axis rotation)
</span>        <span class="n">sinp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">abs</span><span class="p">(</span><span class="n">sinp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pitch</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">copysign</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sinp</span><span class="p">)</span>  <span class="c1"># Use 90 degrees if out of range
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">pitch</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">asin</span><span class="p">(</span><span class="n">sinp</span><span class="p">)</span>
        
        <span class="c1"># Yaw (z-axis rotation)
</span>        <span class="n">siny_cosp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">cosy_cosp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">yaw</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">siny_cosp</span><span class="p">,</span> <span class="n">cosy_cosp</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span>
    
    <span class="k">def</span> <span class="nf">euler_to_quaternion</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Convert euler angles to quaternion.</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">math</span>
        <span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Quaternion</span>
        
        <span class="n">cy</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">pitch</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">pitch</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">roll</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">roll</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">Quaternion</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sr</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">cr</span> <span class="o">*</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">sy</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">cr</span> <span class="o">*</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">sy</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">cr</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">sy</span> <span class="o">-</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">cy</span><span class="p">,</span>
            <span class="n">w</span><span class="o">=</span><span class="n">cr</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">sy</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fusion</span> <span class="o">=</span> <span class="nc">MultiSensorFusion</span><span class="p">()</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="multi-vehicle-coordination"> <a href="#multi-vehicle-coordination" class="anchor-heading" aria-labelledby="multi-vehicle-coordination"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Multi-Vehicle Coordination </h2> <h3 id="example-8-formation-control"> <a href="#example-8-formation-control" class="anchor-heading" aria-labelledby="example-8-formation-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 8: Formation Control </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Formation Control Example

Demonstrates coordinated control of multiple ModCube vehicles
in various formation patterns.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">FormationCommand</span><span class="p">,</span> <span class="n">VehicleState</span>
<span class="kn">from</span> <span class="n">modcube_common.formation</span> <span class="kn">import</span> <span class="n">FormationController</span>

<span class="k">class</span> <span class="nc">FormationControl</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">,</span> <span class="n">num_vehicles</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">formation_control_</span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_id</span> <span class="o">=</span> <span class="n">vehicle_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_vehicles</span> <span class="o">=</span> <span class="n">num_vehicles</span>
        
        <span class="c1"># Formation controller
</span>        <span class="n">self</span><span class="p">.</span><span class="n">formation_controller</span> <span class="o">=</span> <span class="nc">FormationController</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span> <span class="n">num_vehicles</span><span class="p">)</span>
        
        <span class="c1"># Vehicle states
</span>        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">formation_command</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">/modcube_</span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="s">/cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/formation/vehicle_states</span><span class="sh">'</span><span class="p">,</span> <span class="n">VehicleState</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Subscribe to other vehicles' states
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_vehicles</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">vehicle_id</span><span class="p">:</span>
                <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">/modcube_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> 
                               <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">vid</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">vehicle_state_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">vid</span><span class="p">))</span>
        
        <span class="c1"># Formation command subscriber
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/formation/command</span><span class="sh">'</span><span class="p">,</span> <span class="n">FormationCommand</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_command_callback</span><span class="p">)</span>
        
        <span class="c1"># Control timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">control_callback</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Formation control initialized for vehicle </span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">vehicle_state_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Update state of other vehicles.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span><span class="p">[</span><span class="n">vehicle_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">formation_command_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Receive formation command.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">formation_command</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Received formation command: </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="n">formation_type</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">control_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main formation control loop.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_command</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Get current vehicle state
</span>        <span class="n">current_state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_current_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_state</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Calculate formation control
</span>        <span class="n">control_cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">formation_controller</span><span class="p">.</span><span class="nf">compute_control</span><span class="p">(</span>
            <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
            <span class="n">neighbor_states</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">vehicle_states</span><span class="p">,</span>
            <span class="n">formation_command</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">formation_command</span>
        <span class="p">)</span>
        
        <span class="c1"># Publish control command
</span>        <span class="k">if</span> <span class="n">control_cmd</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">control_cmd</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_current_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get current vehicle state.</span><span class="sh">"""</span>
        <span class="c1"># In practice, this would come from the navigation system
</span>        <span class="c1"># For this example, we'll simulate it
</span>        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="nc">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">:</span> <span class="nc">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sh">"</span><span class="s">Usage: formation_control.py &lt;vehicle_id&gt; &lt;num_vehicles&gt;</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vehicle_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">num_vehicles</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">formation</span> <span class="o">=</span> <span class="nc">FormationControl</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span> <span class="n">num_vehicles</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="advanced-applications"> <a href="#advanced-applications" class="anchor-heading" aria-labelledby="advanced-applications"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Applications </h2> <h3 id="example-9-adaptive-control"> <a href="#example-9-adaptive-control" class="anchor-heading" aria-labelledby="example-9-adaptive-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 9: Adaptive Control </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Adaptive Control Example

Demonstrates adaptive control algorithms that adjust
to changing vehicle dynamics and environmental conditions.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">modcube_msgs.msg</span> <span class="kn">import</span> <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">NavState</span>
<span class="kn">from</span> <span class="n">modcube_common.adaptive</span> <span class="kn">import</span> <span class="n">AdaptiveController</span>

<span class="k">class</span> <span class="nc">AdaptiveControlSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">adaptive_control</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Adaptive controller
</span>        <span class="n">self</span><span class="p">.</span><span class="n">adaptive_controller</span> <span class="o">=</span> <span class="nc">AdaptiveController</span><span class="p">()</span>
        
        <span class="c1"># System identification
</span>        <span class="n">self</span><span class="p">.</span><span class="n">system_id</span> <span class="o">=</span> <span class="nc">SystemIdentification</span><span class="p">()</span>
        
        <span class="c1"># Data buffers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">control_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state_history</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Publishers and subscribers
</span>        <span class="n">self</span><span class="p">.</span><span class="n">cmd_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Publisher</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/controller_command</span><span class="sh">'</span><span class="p">,</span> 
                                     <span class="n">ControllerCommand</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nav_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Subscriber</span><span class="p">(</span><span class="sh">'</span><span class="s">/modcube/nav_state</span><span class="sh">'</span><span class="p">,</span> <span class="n">NavState</span><span class="p">,</span> 
                                      <span class="n">self</span><span class="p">.</span><span class="n">nav_callback</span><span class="p">)</span>
        
        <span class="c1"># Adaptation timer
</span>        <span class="n">self</span><span class="p">.</span><span class="n">adapt_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="p">.</span><span class="nc">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">adaptation_callback</span><span class="p">)</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Adaptive control system initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">nav_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process navigation state updates.</span><span class="sh">"""</span>
        <span class="c1"># Store state history for system identification
</span>        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">twist</span><span class="p">.</span><span class="n">linear</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">orientation</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">state_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
        <span class="c1"># Limit history size
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">state_history</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">adaptation_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform parameter adaptation.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">state_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">control_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Identify current system parameters
</span>        <span class="n">identified_params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">system_id</span><span class="p">.</span><span class="nf">identify</span><span class="p">(</span>
            <span class="n">states</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">state_history</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:],</span>
            <span class="n">controls</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">control_history</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        <span class="p">)</span>
        
        <span class="c1"># Update controller parameters
</span>        <span class="k">if</span> <span class="n">identified_params</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">adaptive_controller</span><span class="p">.</span><span class="nf">update_parameters</span><span class="p">(</span><span class="n">identified_params</span><span class="p">)</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Controller parameters adapted</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SystemIdentification</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">System identification for parameter estimation.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model_order</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forgetting_factor</span> <span class="o">=</span> <span class="mf">0.95</span>
    
    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">controls</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Identify system parameters from data.</span><span class="sh">"""</span>
        <span class="c1"># Simplified system identification
</span>        <span class="c1"># In practice, use more sophisticated methods
</span>        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">model_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="c1"># Extract position and velocity data
</span>        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">].</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">position</span><span class="sh">'</span><span class="p">].</span><span class="n">z</span><span class="p">]</span> 
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">].</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="sh">'</span><span class="s">velocity</span><span class="sh">'</span><span class="p">].</span><span class="n">z</span><span class="p">]</span> 
                             <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
        
        <span class="c1"># Simple parameter estimation
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Estimate damping and mass parameters
</span>            <span class="n">damping</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">estimate_damping</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">estimate_mass</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">controls</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">damping</span><span class="sh">'</span><span class="p">:</span> <span class="n">damping</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">mass</span><span class="sh">'</span><span class="p">:</span> <span class="n">mass</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">estimate_damping</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">velocities</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Estimate damping coefficients.</span><span class="sh">"""</span>
        <span class="c1"># Simplified damping estimation
</span>        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">estimate_mass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">controls</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Estimate vehicle mass.</span><span class="sh">"""</span>
        <span class="c1"># Simplified mass estimation
</span>        <span class="k">return</span> <span class="mf">50.0</span>  <span class="c1"># kg
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">adaptive_system</span> <span class="o">=</span> <span class="nc">AdaptiveControlSystem</span><span class="p">()</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="custom-development"> <a href="#custom-development" class="anchor-heading" aria-labelledby="custom-development"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom Development </h2> <h3 id="example-10-custom-mission-plugin"> <a href="#example-10-custom-mission-plugin" class="anchor-heading" aria-labelledby="example-10-custom-mission-plugin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example 10: Custom Mission Plugin </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="sh">"""</span><span class="s">
Custom Mission Plugin Example

Demonstrates how to create custom mission types
by extending the base mission framework.
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">rospy</span>
<span class="kn">from</span> <span class="n">modcube_mission</span> <span class="kn">import</span> <span class="n">BaseMission</span>
<span class="kn">from</span> <span class="n">modcube_common.motion</span> <span class="kn">import</span> <span class="n">MotionClient</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span>

<span class="k">class</span> <span class="nc">CustomSurveyMission</span><span class="p">(</span><span class="n">BaseMission</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Custom survey mission with specific requirements.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">survey_area</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">survey_area</span> <span class="o">=</span> <span class="n">survey_area</span>
        <span class="n">self</span><span class="p">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span> <span class="o">=</span> <span class="nc">MotionClient</span><span class="p">()</span>
        
        <span class="c1"># Mission-specific parameters
</span>        <span class="n">self</span><span class="p">.</span><span class="n">altitude</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">self</span><span class="p">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Custom survey mission initialized</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute the custom survey mission.</span><span class="sh">"""</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting custom survey mission</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Generate survey pattern
</span>            <span class="n">survey_points</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_survey_pattern</span><span class="p">()</span>
            
            <span class="c1"># Execute survey
</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">survey_points</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_aborted</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">False</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">motion_client</span><span class="p">.</span><span class="nf">goto_position</span><span class="p">(</span>
                    <span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">point</span><span class="p">.</span><span class="n">z</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to reach survey point </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Perform survey at this point
</span>                <span class="n">self</span><span class="p">.</span><span class="nf">perform_survey_at_point</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                
                <span class="c1"># Update progress
</span>                <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">survey_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">update_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">completed</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logerr</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Survey mission failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="sh">'</span><span class="s">failed</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">generate_survey_pattern</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate survey waypoints.</span><span class="sh">"""</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">survey_area</span><span class="p">[</span><span class="sh">'</span><span class="s">x_range</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">survey_area</span><span class="p">[</span><span class="sh">'</span><span class="s">y_range</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="n">x_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">resolution</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">y_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">resolution</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">x_steps</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">resolution</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Even rows: bottom to top
</span>                <span class="n">y_range</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="n">y_steps</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Odd rows: top to bottom
</span>                <span class="n">y_range</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="n">y_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">y_range</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">resolution</span>
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">altitude</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">points</span>
    
    <span class="k">def</span> <span class="nf">perform_survey_at_point</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Perform survey operations at a specific point.</span><span class="sh">"""</span>
        <span class="c1"># Custom survey operations
</span>        <span class="n">rospy</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># Simulate data collection time
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rospy</span><span class="p">.</span><span class="nf">init_node</span><span class="p">(</span><span class="sh">'</span><span class="s">custom_survey_mission</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">survey_area</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">x_range</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">y_range</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">mission</span> <span class="o">=</span> <span class="nc">CustomSurveyMission</span><span class="p">(</span><span class="n">survey_area</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">mission</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">loginfo</span><span class="p">(</span><span class="sh">"</span><span class="s">Custom survey mission completed</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="nf">logwarn</span><span class="p">(</span><span class="sh">"</span><span class="s">Custom survey mission failed</span><span class="sh">"</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <h2 id="running-the-examples"> <a href="#running-the-examples" class="anchor-heading" aria-labelledby="running-the-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running the Examples </h2> <h3 id="prerequisites"> <a href="#prerequisites" class="anchor-heading" aria-labelledby="prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h3> <ol> <li><strong>ROS Environment</strong>: Ensure ROS is properly installed and sourced</li> <li><strong>ModCube Workspace</strong>: Build and source the ModCube workspace</li> <li><strong>Simulation Environment</strong>: Launch Gazebo simulation if testing in simulation</li> </ol> <h3 id="basic-setup"> <a href="#basic-setup" class="anchor-heading" aria-labelledby="basic-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Setup </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Source ROS and workspace</span>
<span class="nb">source</span> /opt/ros/melodic/setup.bash
<span class="nb">source</span> ~/modcube_ws/devel/setup.bash

<span class="c"># Launch simulation (optional)</span>
roslaunch modcube_sim_worlds umd.launch

<span class="c"># Launch ModCube system</span>
roslaunch modcube_config system.launch
</code></pre></div></div> <h3 id="running-individual-examples"> <a href="#running-individual-examples" class="anchor-heading" aria-labelledby="running-individual-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running Individual Examples </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Example 1: Basic Position Control</span>
rosrun modcube_examples basic_position_control.py

<span class="c"># Example 2: Velocity Control</span>
rosrun modcube_examples velocity_control.py

<span class="c"># Example 3: Waypoint Navigation</span>
rosrun modcube_examples waypoint_navigation.py

<span class="c"># Example 5: Search and Rescue Mission</span>
rosrun modcube_examples search_rescue_mission.py

<span class="c"># Example 8: Formation Control (multiple terminals)</span>
rosrun modcube_examples formation_control.py 0 3  <span class="c"># Vehicle 0 of 3</span>
rosrun modcube_examples formation_control.py 1 3  <span class="c"># Vehicle 1 of 3</span>
rosrun modcube_examples formation_control.py 2 3  <span class="c"># Vehicle 2 of 3</span>
</code></pre></div></div> <h3 id="monitoring-and-debugging"> <a href="#monitoring-and-debugging" class="anchor-heading" aria-labelledby="monitoring-and-debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Monitoring and Debugging </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Monitor system status</span>
rostopic <span class="nb">echo</span> /modcube/nav_state
rostopic <span class="nb">echo</span> /modcube/controller_command

<span class="c"># Visualize in RViz</span>
rosrun rviz rviz <span class="nt">-d</span> <span class="si">$(</span>rospack find modcube_config<span class="si">)</span>/rviz/modcube.rviz

<span class="c"># Check system diagnostics</span>
rosrun rqt_robot_monitor rqt_robot_monitor
</code></pre></div></div> <h2 id="troubleshooting"> <a href="#troubleshooting" class="anchor-heading" aria-labelledby="troubleshooting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Troubleshooting </h2> <h3 id="common-issues"> <a href="#common-issues" class="anchor-heading" aria-labelledby="common-issues"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Common Issues </h3> <ol> <li><strong>No response to commands</strong> <ul> <li>Check if the controller is running</li> <li>Verify topic names and message types</li> <li>Ensure proper coordinate frames</li> </ul> </li> <li><strong>Simulation not starting</strong> <ul> <li>Check Gazebo installation</li> <li>Verify world files and model paths</li> <li>Check for conflicting processes</li> </ul> </li> <li><strong>Sensor data not available</strong> <ul> <li>Verify sensor plugins are loaded</li> <li>Check topic remapping</li> <li>Ensure proper sensor configuration</li> </ul> </li> </ol> <h3 id="debug-commands"> <a href="#debug-commands" class="anchor-heading" aria-labelledby="debug-commands"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debug Commands </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List active topics</span>
rostopic list

<span class="c"># Check message types</span>
rostopic <span class="nb">type</span> /modcube/nav_state

<span class="c"># Monitor message frequency</span>
rostopic hz /modcube/imu/data

<span class="c"># View node graph</span>
rosrun rqt_graph rqt_graph

<span class="c"># Check parameter server</span>
rosparam list
rosparam get /modcube/controller/pid_gains
</code></pre></div></div> <h2 id="next-steps"> <a href="#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <ol> <li><strong>Modify Examples</strong>: Adapt the examples to your specific requirements</li> <li><strong>Create Custom Missions</strong>: Use the mission framework to develop custom applications</li> <li><strong>Integrate Hardware</strong>: Connect real sensors and actuators</li> <li><strong>Performance Tuning</strong>: Optimize parameters for your specific use case</li> <li><strong>Advanced Features</strong>: Explore machine learning integration and advanced control algorithms</li> </ol> <p>For more detailed information, refer to the <a href="api.md">API Documentation</a> and <a href="tutorials.md">Tutorials</a>.</p> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2024 Jiaxi Zheng. Distributed by an <a href="https://github.com/jiaxi-zheng/ModCube.github.io/tree/main/LICENSE">MIT license.</a></p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
